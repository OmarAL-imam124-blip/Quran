<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø© - v16.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;500;700&display=swap');

        :root {
            --primary: #1a472a;
            --primary-light: #2d5a27;
            --secondary: #2c3e50;
            --accent: #c5a059;
            --gold: #d4af37;
            --bg: #f2f7f5;
            --card-bg: #ffffff;
            --text: #333;
            --border: #dee2e6;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Tajawal', sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 2rem;
            text-align: center;
            border-bottom: 6px solid var(--accent);
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        }

        .app-header h1 {
            font-family: 'Amiri', serif;
            font-size: 2.8rem;
            margin-bottom: 0.2rem;
        }

        .container {
            max-width: 1300px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }

        .view {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .view.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 2.5rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0,0,0,0.03);
            margin-bottom: 2.5rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2.5rem;
        }

        h2 { color: var(--primary); margin-bottom: 1.5rem; font-size: 1.8rem; display: flex; align-items: center; gap: 12px; }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
        }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }

        .range-selector {
            background: #f9f9f9;
            padding: 1.5rem;
            border-radius: 20px;
            border: 1px solid #eee;
            margin-bottom: 1.5rem;
        }

        .selector-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 0.5fr;
            gap: 15px;
            margin-top: 10px;
            align-items: end;
        }

        .quick-templates {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .template-btn {
            background: #fff;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .template-btn:hover { background: var(--primary); color: #fff; }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #ddd;
            font-size: 1rem;
            outline: none;
        }

        .mode-selector {
            display: flex;
            background: #eee;
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 1.5rem;
        }
        .mode-option {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            font-weight: bold;
            transition: 0.3s;
        }
        .mode-option.active { background: var(--primary); color: white; }

        .verse-box {
            background: #fff;
            border: 3px solid var(--primary);
            border-radius: 30px;
            padding: 4rem 2rem;
            text-align: center;
            margin-bottom: 2.5rem;
            box-shadow: 0 10px 20px rgba(26,71,42,0.1);
        }
        .verse-text { font-family: 'Amiri', serif; font-size: 3.5rem; color: var(--primary); line-height: 1.6; margin-bottom: 1.5rem; }

        .tajweed-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 2rem;
        }
        .taj-chip {
            background: #f8f9fa;
            border: 1.5px solid #dee2e6;
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
        }
        .taj-chip.selected { background: var(--danger); color: white; border-color: var(--danger); }

        .table-container { overflow-x: auto; border-radius: 20px; }
        table { width: 100%; border-collapse: collapse; background: #fff; }
        th, td { padding: 18px; text-align: right; border-bottom: 1px solid #f1f1f1; }
        th { background: #f9fbf9; color: var(--primary); font-weight: 700; }

        .student-link { color: var(--primary); font-weight: 700; cursor: pointer; text-decoration: none; border-bottom: 1.5px solid var(--accent); }

        .badge { padding: 6px 14px; border-radius: 25px; font-size: 0.85rem; font-weight: 800; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fffbeb; color: #92400e; }

        /* Certificate Styles - Professional Re-design */
        #printCertificate {
            width: 1100px;
            height: 780px;
            background: #fff;
            padding: 50px;
            position: relative;
            display: none;
            margin: 0 auto;
            border: 2px solid var(--accent);
            overflow: hidden;
            box-sizing: border-box;
        }

        .cert-border-outer {
            border: 20px solid var(--primary);
            height: 100%;
            width: 100%;
            position: relative;
            box-sizing: border-box;
        }

        .cert-border-inner {
            border: 5px double var(--accent);
            height: calc(100% - 20px);
            width: calc(100% - 20px);
            margin: 10px;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            text-align: center;
            position: relative;
            box-sizing: border-box;
        }

        .cert-corner {
            position: absolute;
            width: 60px;
            height: 60px;
            border: 10px solid var(--accent);
            z-index: 10;
        }
        .top-left { top: -10px; left: -10px; border-right: none; border-bottom: none; }
        .top-right { top: -10px; right: -10px; border-left: none; border-bottom: none; }
        .bottom-left { bottom: -10px; left: -10px; border-right: none; border-top: none; }
        .bottom-right { bottom: -10px; right: -10px; border-left: none; border-top: none; }

        .cert-header { font-size: 1.2rem; font-weight: bold; color: var(--secondary); }
        .cert-title { font-family: 'Amiri', serif; font-size: 4.5rem; color: var(--primary); margin: 10px 0; }
        .cert-body { font-size: 1.8rem; line-height: 1.8; color: #444; }
        .cert-name { font-family: 'Amiri', serif; font-size: 4rem; color: var(--accent); font-weight: bold; text-decoration: underline; margin: 15px 0; }
        .cert-score { font-size: 2.5rem; font-weight: 900; color: var(--primary); }
        .cert-footer { display: flex; justify-content: space-between; margin-top: 40px; padding: 0 50px; align-items: flex-end; }
        .signature-line { border-top: 2px solid #333; width: 220px; padding-top: 10px; font-weight: bold; font-size: 1.2rem; }

        @media print {
            body * { visibility: hidden; }
            #printCertificate, #printCertificate * { visibility: visible; }
            #printCertificate { position: absolute; left: 0; top: 0; display: block !important; }
        }

        @media (max-width: 1000px) {
            .main-grid { grid-template-columns: 1fr; }
            .selector-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header class="app-header no-print">
        <h1>Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ Ø§Ù„Ø°ÙƒÙŠ <small style="font-size: 1rem; opacity: 0.8;">v16.0</small></h1>
        <p>Ù…Ù†ØµØ© ØªÙ‚ÙŠÙŠÙ… ÙˆØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</p>
    </header>

    <div class="container no-print">
        
        <!-- View 1: Main Dashboard -->
        <div id="mainDashboard" class="view active">
            <div class="main-grid">
                <div class="main-column">
                    <div class="card">
                        <h2>ğŸ‘¤ Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯</h2>
                        
                        <div class="range-selector">
                            <div style="margin-bottom: 1.5rem;">
                                <label style="font-weight: bold; color: var(--secondary);">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø®ØªØ¨Ø±:</label>
                                <input type="text" id="teacherNameInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…..." style="margin-top: 8px;">
                            </div>

                            <label style="font-weight: bold; color: var(--primary);">Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³ÙˆØ± ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label>
                            <div class="selector-grid">
                                <div>
                                    <label style="font-size: 0.8rem; display: block;">Ù…Ù† Ø³ÙˆØ±Ø©:</label>
                                    <select id="startSurah"></select>
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; display: block;">Ø¥Ù„Ù‰ Ø³ÙˆØ±Ø©:</label>
                                    <select id="endSurah"></select>
                                </div>
                                <div>
                                    <label style="font-size: 0.8rem; display: block; color: var(--success); font-weight: bold;">Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</label>
                                    <input type="number" id="questionCount" value="5" min="1" max="10">
                                </div>
                            </div>
                            
                            <div class="quick-templates">
                                <span>Ù†Ù…Ø§Ø°Ø¬ Ø³Ø±ÙŠØ¹Ø©:</span>
                                <button class="template-btn" onclick="applyTemplate(77, 113, 5)">Ø¬Ø²Ø¡ Ø¹Ù…Ù‘</button>
                                <button class="template-btn" onclick="applyTemplate(66, 76, 5)">Ø¬Ø²Ø¡ ØªØ¨Ø§Ø±Ùƒ</button>
                                <button class="template-btn" onclick="applyTemplate(0, 113, 10)">Ø§Ù„Ù‚Ø±Ø¢Ù† ÙƒØ§Ù…Ù„Ø§Ù‹</button>
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px;">
                            <input type="text" id="studentSearchInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ..." style="flex: 1; padding: 15px; border-radius: 12px; border: 2px solid #eee; font-size: 1.1rem; outline: none;">
                            <button class="btn btn-primary" onclick="startAssessment()">Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
                        </div>
                    </div>

                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ</h2>
                            <button class="btn btn-outline btn-sm" onclick="exportDataExcel()">ØªØµØ¯ÙŠØ± CSV</button>
                        </div>
                        <div class="table-container">
                            <table id="mainResultsTable">
                                <thead>
                                    <tr>
                                        <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                        <th>Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                                        <th>Ø§Ù„Ù†Ø·Ø§Ù‚</th>
                                        <th>Ø¨Ø¥Ø´Ø±Ø§Ù</th>
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsGrid"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="side-column">
                    <div class="card">
                        <h2>ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h2>
                        <div id="topStudentsList"></div>
                    </div>
                    <div class="card" style="background: #fffdf5; border: 1px solid #ffeeba;">
                        <h2 style="font-size: 1.3rem;">ğŸ’¡ ØªÙˆØ¬ÙŠÙ‡</h2>
                        <p id="dailyPedagogicalTip" style="font-style: italic; color: #744210;"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- View 2: Assessment Mode -->
        <div id="assessmentView" class="view">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <div>
                        <h2 id="liveStudentName">...</h2>
                        <div id="activeRangeLabel" style="font-size: 0.9rem; color: #666;">...</div>
                    </div>
                    <div id="progressCounter" style="font-weight: bold; color: var(--accent); font-size: 1.4rem;">...</div>
                </div>

                <div class="verse-box">
                    <div id="verseDisplayArea" class="verse-text"></div>
                </div>

                <div class="tajweed-box" style="padding: 15px; background: #f1f3f5; border-radius: 15px; margin-bottom: 20px;">
                    <label style="font-weight: bold;">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ¬ÙˆÙŠØ¯ÙŠØ©:</label>
                    <div class="tajweed-grid" style="margin-top: 10px;">
                        <div class="taj-chip" onclick="this.classList.toggle('selected')">ØºÙ†Ø©</div>
                        <div class="taj-chip" onclick="this.classList.toggle('selected')">Ù…Ø¯ÙˆØ¯</div>
                        <div class="taj-chip" onclick="this.classList.toggle('selected')">Ù…Ø®Ø§Ø±Ø¬</div>
                        <div class="taj-chip" onclick="this.classList.toggle('selected')">ÙˆÙ‚Ù</div>
                        <div class="taj-chip" onclick="this.classList.toggle('selected')">Ù‚Ù„Ù‚Ù„Ø©</div>
                        <div class="taj-chip" onclick="this.classList.toggle('selected')">Ø¥Ø®ÙØ§Ø¡</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
                    <button class="btn" style="background: var(--success); color: white; height: 70px; font-size: 1.5rem;" onclick="gradeStep(2)">ØµØ­ÙŠØ­ (2)</button>
                    <button class="btn" style="background: var(--warning); color: white; height: 70px; font-size: 1.5rem;" onclick="gradeStep(1)">ØªØ±Ø¯Ø¯ (1)</button>
                    <button class="btn" style="background: var(--danger); color: white; height: 70px; font-size: 1.5rem;" onclick="gradeStep(0)">Ø®Ø·Ø£ (0)</button>
                </div>
            </div>
        </div>

        <!-- View 3: Final Results -->
        <div id="performanceSummaryView" class="view">
            <div class="card" style="text-align: center; padding: 4rem 2rem;">
                <h2 style="justify-content: center; font-size: 2.2rem;">Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
                <div style="font-size: 6rem; font-weight: 900; color: var(--primary); margin: 1rem 0;" id="finalScoreBadge">0 / 0</div>
                <div id="finalLevelStatus"></div>
                
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 2rem; flex-wrap: wrap;">
                    <button id="btnCertificate" class="btn btn-accent" style="display:none" onclick="triggerCertificatePrint()">ğŸ“„ Ø¥ØµØ¯Ø§Ø± Ø´Ù‡Ø§Ø¯Ø© Ù…Ù„ÙƒÙŠØ©</button>
                    <button class="btn btn-success" onclick="shareOnWhatsApp()">ğŸ’¬ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙˆØ§ØªØ³Ø§Ø¨</button>
                    <button class="btn btn-primary" onclick="saveRecordAndClose()">Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Professional Certificate Template -->
    <div id="printCertificate">
        <div class="cert-border-outer">
            <div class="cert-border-inner">
                <!-- Corners Decorative Elements -->
                <div class="cert-corner top-left"></div>
                <div class="cert-corner top-right"></div>
                <div class="cert-corner bottom-left"></div>
                <div class="cert-corner bottom-right"></div>

                <div class="cert-header">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</div>
                <h1 class="cert-title">Ø´ÙÙ‡ÙØ§Ø¯ÙØ© ØªÙÙ‚Ù’Ø¯ÙÙŠØ± ÙˆÙØªÙÙÙÙˆÙÙ‘Ù‚</h1>
                
                <div class="cert-body">
                    Ø¨ÙÙÙØ¶Ù’Ù„Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù ØªÙØ¹ÙØ§Ù„ÙÙ‰ ÙˆÙØ¨ÙØªÙÙˆÙ’ÙÙÙŠÙ‚ÙÙ‡ÙØŒ ÙŠÙØ³ÙØ±ÙÙ‘ Ø§Ù„Ù…Ø¹Ù„Ù…: 
                    <span id="certTeacherName" style="font-weight: bold; color: var(--primary);">...</span>
                    Ø£ÙÙ†Ù’ ÙŠÙÙ…Ù’Ù†ÙØ­Ù Ù‡ÙØ°ÙÙ‡Ù Ø§Ù„Ø´ÙÙ‘Ù‡ÙØ§Ø¯ÙØ©Ù Ù„ÙÙ„Ø·ÙÙ‘Ø§Ù„ÙØ¨Ù Ø§Ù„Ù…ØªÙ…ÙŠØ²:
                </div>

                <div class="cert-name" id="certNameSlot">...</div>

                <div class="cert-body">
                    Ù„ÙØªÙÙ…ÙÙŠÙÙ‘Ø²ÙÙ‡Ù ÙˆÙØ¥ÙØªÙ’Ù‚ÙØ§Ù†ÙÙ‡Ù ÙÙÙŠ Ø§Ø®Ù’ØªÙØ¨ÙØ§Ø±Ù Ù…ÙØ±ÙØ§Ø¬ÙØ¹ÙØ©Ù:
                    <br><span id="certRangeSlot" style="font-weight: bold; color: var(--secondary);">...</span>
                    <br>Ø¨ÙØªÙÙ‚Ù’Ø¯ÙÙŠØ±Ù Ù…ÙÙ…Ù’ØªÙØ§Ø²Ù ÙˆÙØ¨ÙØ¯ÙØ±ÙØ¬ÙØ©Ù Ù†ÙÙ‡ÙØ§Ø¦ÙÙŠÙÙ‘Ø©Ù:
                </div>

                <div class="cert-score" id="certScoreSlot">...</div>

                <div class="cert-body" style="font-style: italic; font-size: 1.4rem;">
                    "Ø®ÙÙŠÙ’Ø±ÙÙƒÙÙ…Ù’ Ù…ÙÙ†Ù’ ØªÙØ¹ÙÙ„ÙÙ‘Ù…Ù Ø§Ù„Ù’Ù‚ÙØ±Ù’Ø¢Ù†Ù ÙˆÙØ¹ÙÙ„ÙÙ‘Ù…ÙÙ‡Ù"
                </div>

                <div class="cert-footer">
                    <div>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±: <br> <span id="certDateSlot"></span></div>
                    <div style="text-align: center;">
                        Ø®ÙØªÙ’Ù…Ù ÙˆÙØªÙÙˆÙ’Ù‚ÙÙŠØ¹Ù Ø§Ù„Ù…Ø¹Ù„Ù… <br>
                        <div class="signature-line" id="certSignatureName">...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let storageDB;
        const dbReq = indexedDB.open("QuranComprehensiveV16", 1);
        dbReq.onupgradeneeded = (e) => {
            storageDB = e.target.result;
            if (!storageDB.objectStoreNames.contains("voiceLogs")) storageDB.createObjectStore("voiceLogs", { keyPath: "id" });
        };
        dbReq.onsuccess = (e) => { storageDB = e.target.result; syncDashboard(); };

        const surahs = ["Ø§Ù„ÙØ§ØªØ­Ø©","Ø§Ù„Ø¨Ù‚Ø±Ø©","Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†","Ø§Ù„Ù†Ø³Ø§Ø¡","Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©","Ø§Ù„Ø£Ù†Ø¹Ø§Ù…","Ø§Ù„Ø£Ø¹Ø±Ø§Ù","Ø§Ù„Ø£Ù†ÙØ§Ù„","Ø§Ù„ØªÙˆØ¨Ø©","ÙŠÙˆÙ†Ø³","Ù‡ÙˆØ¯","ÙŠÙˆØ³Ù","Ø§Ù„Ø±Ø¹Ø¯","Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…","Ø§Ù„Ø­Ø¬Ø±","Ø§Ù„Ù†Ø­Ù„","Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡","Ø§Ù„ÙƒÙ‡Ù","Ù…Ø±ÙŠÙ…","Ø·Ù‡","Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡","Ø§Ù„Ø­Ø¬","Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†","Ø§Ù„Ù†ÙˆØ±","Ø§Ù„ÙØ±Ù‚Ø§Ù†","Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡","Ø§Ù„Ù†Ù…Ù„","Ø§Ù„Ù‚ØµØµ","Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª","Ø§Ù„Ø±ÙˆÙ…","Ù„Ù‚Ù…Ø§Ù†","Ø§Ù„Ø³Ø¬Ø¯Ø©","Ø§Ù„Ø£Ø­Ø²Ø§Ø¨","Ø³Ø¨Ø£","ÙØ§Ø·Ø±","ÙŠØ³","Ø§Ù„ØµØ§ÙØ§Øª","Øµ","Ø§Ù„Ø²Ù…Ø±","ØºØ§ÙØ±","ÙØµÙ„Øª","Ø§Ù„Ø´ÙˆØ±Ù‰","Ø§Ù„Ø²Ø®Ø±Ù","Ø§Ù„Ø¯Ø®Ø§Ù†","Ø§Ù„Ø¬Ø§Ø«ÙŠØ©","Ø§Ù„Ø£Ø­Ù‚Ø§Ù","Ù…Ø­Ù…Ø¯","Ø§Ù„ÙØªØ­","Ø§Ù„Ø­Ø¬Ø±Ø§Øª","Ù‚","Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª","Ø§Ù„Ø·ÙˆØ±","Ø§Ù„Ù†Ø¬Ù…","Ø§Ù„Ù‚Ù…Ø±","Ø§Ù„Ø±Ø­Ù…Ù†","Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©","Ø§Ù„Ø­Ø¯ÙŠØ¯","Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©","Ø§Ù„Ø­Ø´Ø±","Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©","Ø§Ù„ØµÙ","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†","Ø§Ù„ØªØºØ§Ø¨Ù†","Ø§Ù„Ø·Ù„Ø§Ù‚","Ø§Ù„ØªØ­Ø±ÙŠÙ…","Ø§Ù„Ù…Ù„Ùƒ","Ø§Ù„Ù‚Ù„Ù…","Ø§Ù„Ø­Ø§Ù‚Ø©","Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬","Ù†ÙˆØ­","Ø§Ù„Ø¬Ù†","Ø§Ù„Ù…Ø²Ù…Ù„","Ø§Ù„Ù…Ø¯Ø«Ø±","Ø§Ù„Ù‚ÙŠØ§Ù…Ø©","Ø§Ù„Ø¥Ù†Ø³Ø§Ù†","Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª","Ø§Ù„Ù†Ø¨Ø£","Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª","Ø¹Ø¨Ø³","Ø§Ù„ØªÙƒÙˆÙŠØ±","Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±","Ø§Ù„Ù…Ø·ÙÙÙŠÙ†","Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚","Ø§Ù„Ø¨Ø±ÙˆØ¬","Ø§Ù„Ø·Ø§Ø±Ù‚","Ø§Ù„Ø£Ø¹Ù„Ù‰","Ø§Ù„ØºØ§Ø´ÙŠØ©","Ø§Ù„ÙØ¬Ø±","Ø§Ù„Ø¨Ù„Ø¯","Ø§Ù„Ø´Ù…Ø³","Ø§Ù„Ù„ÙŠÙ„","Ø§Ù„Ø¶Ø­Ù‰","Ø§Ù„Ø´Ø±Ø­","Ø§Ù„ØªÙŠÙ†","Ø§Ù„Ø¹Ù„Ù‚","Ø§Ù„Ù‚Ø¯Ø±","Ø§Ù„Ø¨ÙŠÙ†Ø©","Ø§Ù„Ø²Ù„Ø²Ù„Ø©","Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª","Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©","Ø§Ù„ØªÙƒØ§Ø«Ø±","Ø§Ù„Ø¹ØµØ±","Ø§Ù„Ù‡Ù…Ø²Ø©","Ø§Ù„ÙÙŠÙ„","Ù‚Ø±ÙŠØ´","Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†","Ø§Ù„ÙƒÙˆØ«Ø±","Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†","Ø§Ù„Ù†ØµØ±","Ø§Ù„Ù…Ø³Ø¯","Ø§Ù„Ø¥Ø®Ù„Ø§Øµ","Ø§Ù„ÙÙ„Ù‚","Ø§Ù„Ù†Ø§Ø³"];

        const comprehensiveBank = [
            { t: "ï´¿Ø°ÙÙ„ÙÙƒÙ Ø§Ù„Ù’ÙƒÙØªÙØ§Ø¨Ù Ù„ÙØ§ Ø±ÙÙŠÙ’Ø¨Ù ÙÙÙŠÙ‡Ù Ù‡ÙØ¯Ù‹Ù‰ Ù„Ù‘ÙÙ„Ù’Ù…ÙØªÙ‘ÙÙ‚ÙÙŠÙ†Ùï´¾", sidx: 1, s: "Ø§Ù„Ø¨Ù‚Ø±Ø©", j: 1 },
            { t: "ï´¿Ø´ÙÙ‡Ù’Ø±Ù Ø±ÙÙ…ÙØ¶ÙØ§Ù†Ù Ø§Ù„Ù‘ÙØ°ÙÙŠ Ø£ÙÙ†Ø²ÙÙ„Ù ÙÙÙŠÙ‡Ù Ø§Ù„Ù’Ù‚ÙØ±Ù’Ø¢Ù†Ù Ù‡ÙØ¯Ù‹Ù‰ Ù„Ù‘ÙÙ„Ù†Ù‘ÙØ§Ø³Ùï´¾", sidx: 1, s: "Ø§Ù„Ø¨Ù‚Ø±Ø©", j: 2 },
            { t: "ï´¿Ù„ÙÙ† ØªÙÙ†ÙØ§Ù„ÙÙˆØ§ Ø§Ù„Ù’Ø¨ÙØ±Ù‘Ù Ø­ÙØªÙ‘ÙÙ‰ ØªÙÙ†ÙÙÙ‚ÙÙˆØ§ Ù…ÙÙ…Ù‘ÙØ§ ØªÙØ­ÙØ¨Ù‘ÙÙˆÙ†Ùï´¾", sidx: 2, s: "Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†", j: 4 },
            { t: "ï´¿Ø³ÙØ¨Ù’Ø­ÙØ§Ù†Ù Ø§Ù„Ù‘ÙØ°ÙÙŠ Ø£ÙØ³Ù’Ø±ÙÙ‰ Ø¨ÙØ¹ÙØ¨Ù’Ø¯ÙÙ‡Ù Ù„ÙÙŠÙ’Ù„Ù‹Ø§ Ù…Ù‘ÙÙ†Ù Ø§Ù„Ù’Ù…ÙØ³Ù’Ø¬ÙØ¯Ù Ø§Ù„Ù’Ø­ÙØ±ÙØ§Ù…Ùï´¾", sidx: 16, s: "Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡", j: 15 },
            { t: "ï´¿ØªÙØ¨ÙØ§Ø±ÙÙƒÙ Ø§Ù„Ù‘ÙØ°ÙÙŠ Ø¨ÙÙŠÙØ¯ÙÙ‡Ù Ø§Ù„Ù’Ù…ÙÙ„Ù’ÙƒÙ ÙˆÙÙ‡ÙÙˆÙ Ø¹ÙÙ„ÙÙ‰ ÙƒÙÙ„Ù‘Ù Ø´ÙÙŠÙ’Ø¡Ù Ù‚ÙØ¯ÙÙŠØ±ÙŒï´¾", sidx: 66, s: "Ø§Ù„Ù…Ù„Ùƒ", j: 29 },
            { t: "ï´¿Ø¹ÙÙ…Ù‘Ù ÙŠÙØªÙØ³ÙØ§Ø¡ÙÙ„ÙÙˆÙ†Ù * Ø¹ÙÙ†Ù Ø§Ù„Ù†Ù‘ÙØ¨ÙØ¥Ù Ø§Ù„Ù’Ø¹ÙØ¸ÙÙŠÙ…Ùï´¾", sidx: 77, s: "Ø§Ù„Ù†Ø¨Ø£", j: 30 },
            { t: "ï´¿ÙˆÙØ§Ù„Ù’Ù…ÙØ±Ù’Ø³ÙÙ„ÙØ§ØªÙ Ø¹ÙØ±Ù’ÙÙ‹Ø§ * ÙÙØ§Ù„Ù’Ø¹ÙØ§ØµÙÙÙØ§ØªÙ Ø¹ÙØµÙ’ÙÙ‹Ø§ï´¾", sidx: 76, s: "Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª", j: 29 },
            { t: "ï´¿ÙŠÙØ§ Ø£ÙÙŠÙ‘ÙÙ‡ÙØ§ Ø§Ù„Ù’Ù…ÙØ²Ù‘ÙÙ…Ù‘ÙÙ„Ù * Ù‚ÙÙ…Ù Ø§Ù„Ù„Ù‘ÙÙŠÙ’Ù„Ù Ø¥ÙÙ„Ù‘ÙØ§ Ù‚ÙÙ„ÙÙŠÙ„Ù‹Ø§ï´¾", sidx: 72, s: "Ø§Ù„Ù…Ø²Ù…Ù„", j: 29 },
            { t: "ï´¿Ø¥ÙÙ†Ù‘ÙØ§ Ø£ÙØ¹Ù’Ø·ÙÙŠÙ’Ù†ÙØ§ÙƒÙ Ø§Ù„Ù’ÙƒÙÙˆÙ’Ø«ÙØ±Ù * ÙÙØµÙÙ„Ù‘Ù Ù„ÙØ±ÙØ¨Ù‘ÙÙƒÙ ÙˆÙØ§Ù†Ù’Ø­ÙØ±Ù’ï´¾", sidx: 107, s: "Ø§Ù„ÙƒÙˆØ«Ø±", j: 30 },
            { t: "ï´¿Ø§Ù‚Ù’Ø±ÙØ£Ù’ Ø¨ÙØ§Ø³Ù’Ù…Ù Ø±ÙØ¨Ù‘ÙÙƒÙ Ø§Ù„Ù‘ÙØ°ÙÙŠ Ø®ÙÙ„ÙÙ‚Ùï´¾", sidx: 95, s: "Ø§Ù„Ø¹Ù„Ù‚", j: 30 },
            { t: "ï´¿Ù‚ÙÙ„ Ù„Ù‘ÙÙ† ÙŠÙØµÙÙŠØ¨ÙÙ†ÙØ§ Ø¥ÙÙ„Ù‘ÙØ§ Ù…ÙØ§ ÙƒÙØªÙØ¨Ù Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ù„ÙÙ†ÙØ§ï´¾", sidx: 8, s: "Ø§Ù„ØªÙˆØ¨Ø©", j: 10 }
        ];

        let state = {
            teacherName: localStorage.getItem('teacher_name') || "",
            mode: 'normal', student: "", scores: [], mistakes: [], step: 0, 
            activePool: [], totalQ: 5,
            archive: JSON.parse(localStorage.getItem('v16_archive') || '[]'),
            startS: 0, endS: 113
        };

        window.onload = () => {
            initSelectors();
            document.getElementById('teacherNameInput').value = state.teacherName;
            syncDashboard();
        };

        function initSelectors() {
            const startSelect = document.getElementById('startSurah');
            const endSelect = document.getElementById('endSurah');
            surahs.forEach((s, i) => {
                startSelect.innerHTML += `<option value="${i}">${s}</option>`;
                endSelect.innerHTML += `<option value="${i}" ${i===113?'selected':''}>${s}</option>`;
            });
        }

        function applyTemplate(from, to, count) {
            document.getElementById('startSurah').value = from;
            document.getElementById('endSurah').value = to;
            document.getElementById('questionCount').value = count;
        }

        function startAssessment() {
            const name = document.getElementById('studentSearchInput').value.trim();
            const teacher = document.getElementById('teacherNameInput').value.trim();
            if (!name) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨");
            if (!teacher) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø®ØªØ¨Ø±");

            // Save teacher name for next time
            state.teacherName = teacher;
            localStorage.setItem('teacher_name', teacher);

            const from = parseInt(document.getElementById('startSurah').value);
            const to = parseInt(document.getElementById('endSurah').value);
            const qCount = parseInt(document.getElementById('questionCount').value);

            let pool = comprehensiveBank.filter(v => v.sidx >= from && v.sidx <= to);
            if (pool.length < 1) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© ÙƒØ§ÙÙŠØ© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø·Ø§Ù‚.");

            state.student = name;
            state.scores = [];
            state.mistakes = [];
            state.step = 0;
            state.totalQ = Math.min(qCount, pool.length);
            state.activePool = pool.sort(() => 0.5 - Math.random()).slice(0, state.totalQ);
            state.startS = from; state.endS = to;

            document.getElementById('liveStudentName').innerText = `Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨: ${name}`;
            document.getElementById('activeRangeLabel').innerText = `Ø§Ù„Ù†Ø·Ø§Ù‚: Ù…Ù† ${surahs[from]} Ø¥Ù„Ù‰ ${surahs[to]}`;
            
            showStep();
            document.getElementById('mainDashboard').classList.remove('active');
            document.getElementById('assessmentView').classList.add('active');
        }

        function showStep() {
            const v = state.activePool[state.step];
            document.getElementById('progressCounter').innerText = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${state.step + 1} / ${state.totalQ}`;
            document.getElementById('verseDisplayArea').innerText = v.t;
            document.querySelectorAll('.taj-chip').forEach(c => c.classList.remove('selected'));
        }

        function gradeStep(pts) {
            state.scores.push(pts);
            document.querySelectorAll('.taj-chip.selected').forEach(c => state.mistakes.push(c.innerText));
            state.step++;
            if (state.step < state.totalQ) showStep(); else finish();
        }

        function finish() {
            const total = state.scores.reduce((a,b) => a+b, 0);
            const maxPossible = state.totalQ * 2;
            document.getElementById('finalScoreBadge').innerText = `${total} / ${maxPossible}`;
            const pct = (total / maxPossible) * 100;
            const lvl = pct >= 90 ? "Ù…Ù…ØªØ§Ø²" : pct >= 70 ? "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹" : "ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©";
            document.getElementById('finalLevelStatus').innerHTML = `<span class="badge ${pct >= 90 ? 'badge-success' : 'badge-warning'}">${lvl}</span>`;
            if (pct >= 90) document.getElementById('btnCertificate').style.display = "inline-flex";
            
            document.getElementById('assessmentView').classList.remove('active');
            document.getElementById('performanceSummaryView').classList.add('active');
        }

        function saveRecordAndClose() {
            const rid = Date.now();
            const record = {
                id: rid, name: state.student, score: state.scores.reduce((a,b)=>a+b, 0), max: state.totalQ * 2,
                range: `Ù…Ù† ${surahs[state.startS]} Ø¥Ù„Ù‰ ${surahs[state.endS]}`,
                teacher: state.teacherName,
                date: new Date().toLocaleDateString('ar-SA'), 
                mistakes: [...new Set(state.mistakes)].join('ØŒ ')
            };
            state.archive.unshift(record);
            localStorage.setItem('v16_archive', JSON.stringify(state.archive));
            syncDashboard();
            document.getElementById('performanceSummaryView').classList.remove('active');
            document.getElementById('mainDashboard').classList.add('active');
        }

        function syncDashboard() {
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '';
            state.archive.slice(0, 15).forEach(res => {
                grid.innerHTML += `<tr><td><span class="student-link">${res.name}</span></td><td><b>${res.score}/${res.max}</b></td><td>${res.range}</td><td>${res.teacher || '--'}</td><td>${res.date}</td></tr>`;
            });
            document.getElementById('dailyPedagogicalTip').innerText = "Ø§Ù„Ù…Ø¹Ù„Ù… Ù‡Ùˆ Ø§Ù„Ù‚Ø¯ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù„Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ ØªØ¹Ø¸ÙŠÙ…Ù‡ Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ù„Ù‡.";
        }

        function triggerCertificatePrint() {
            document.getElementById('certNameSlot').innerText = state.student;
            document.getElementById('certTeacherName').innerText = state.teacherName;
            document.getElementById('certSignatureName').innerText = state.teacherName;
            document.getElementById('certScoreSlot').innerText = `${state.scores.reduce((a,b)=>a+b,0)} / ${state.totalQ * 2}`;
            document.getElementById('certRangeSlot').innerText = document.getElementById('activeRangeLabel').innerText;
            document.getElementById('certDateSlot').innerText = new Date().toLocaleDateString('ar-SA');
            window.print();
        }

        function shareOnWhatsApp() {
            const total = state.scores.reduce((a,b) => a+b, 0);
            const max = state.totalQ * 2;
            const text = `Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ³Ù…ÙŠØ¹ ğŸ“–%0AØ§Ù„Ø·Ø§Ù„Ø¨: ${state.student}%0AØ§Ù„Ø¯Ø±Ø¬Ø©: ${total}/${max}%0AØ§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø´Ø±Ù: ${state.teacherName}%0AØ§Ù„Ù†Ø·Ø§Ù‚: ${document.getElementById('activeRangeLabel').innerText}%0AØ¨Ø§Ø±Ùƒ Ø§Ù„Ù„Ù‡ ÙÙŠÙ‡ ÙˆØ²Ø§Ø¯Ù‡ Ø­Ø±ØµØ§Ù‹.`;
            window.open(`https://wa.me/?text=${text}`, '_blank');
        }

        function exportDataExcel() {
            let csv = "Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ø¯Ø±Ø¬Ø©,Ø§Ù„Ù†Ø·Ø§Ù‚,Ø§Ù„Ù…Ø¹Ù„Ù…,Ø§Ù„ØªØ§Ø±ÙŠØ®\n";
            state.archive.forEach(r => csv += `${r.name},${r.score}/${r.max},${r.range},${r.teacher},${r.date}\n`);
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv' });
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = "Ø³Ø¬Ù„_Ø§Ù„Ø­Ù„Ù‚Ø©_v16.csv"; link.click();
        }
    </script>
</body>
</html>
