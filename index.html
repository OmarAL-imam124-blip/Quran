<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© - v29.1</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;500;700&family=Playfair+Display:wght@400;700&display=swap');

        :root {
            --primary: #1a472a;
            --primary-light: #2d5a27;
            --secondary: #2c3e50;
            --accent: #c5a059;
            --gold: #d4af37;
            --bg: #f8faf9;
            --card-bg: #ffffff;
            --text: #333;
            --border: #dee2e6;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --shadow: 0 10px 40px rgba(0,0,0,0.08);
        }

        .dark-mode {
            --bg: #1a1a1a;
            --card-bg: #2d2d2d;
            --text: #e0e0e0;
            --border: #444;
            --secondary: #94a3b8;
        }

        [dir="ltr"] {
            font-family: 'Tajawal', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Tajawal', sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 2.5rem;
            text-align: center;
            border-bottom: 6px solid var(--accent);
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
            position: relative;
        }

        .top-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            backdrop-filter: blur(5px);
            transition: 0.2s;
        }
        .control-btn:hover { background: rgba(255,255,255,0.4); }

        .app-header h1 {
            font-family: 'Amiri', serif;
            font-size: 2.8rem;
            margin-bottom: 0.2rem;
        }

        .container {
            max-width: 1300px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }

        .view {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .view.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 2.5rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0,0,0,0.03);
            margin-bottom: 2.5rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2.5rem;
        }

        h2 { color: var(--primary); margin-bottom: 1.5rem; font-size: 1.8rem; display: flex; align-items: center; gap: 12px; }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
        }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }

        .watermark {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 9999;
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(26, 71, 42, 0.1);
            backdrop-filter: blur(5px);
            padding: 8px 15px;
            border-radius: 50px;
            border: 1px solid var(--gold);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .watermark-text {
            font-family: 'Amiri', serif;
            font-size: 1rem;
            color: var(--primary);
            font-weight: bold;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 1.5rem;
            background: rgba(0,0,0,0.03);
            padding: 1.5rem;
            border-radius: 20px;
        }

        select, input, textarea {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text);
            font-size: 1rem;
            outline: none;
        }

        .verse-box {
            background: var(--card-bg);
            border: 3px solid var(--primary);
            border-radius: 30px;
            padding: 4rem 2rem;
            text-align: center;
            margin-bottom: 2.5rem;
            box-shadow: 0 10px 20px rgba(26,71,42,0.1);
            position: relative;
        }
        .verse-text { font-family: 'Amiri', serif; font-size: 3.5rem; color: var(--primary); line-height: 1.6; margin-bottom: 1.5rem; }
        
        .error-counter-box {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 1rem 0;
            padding: 10px;
            background: rgba(231, 76, 60, 0.1);
            border-radius: 15px;
        }
        .error-dot {
            width: 20px; height: 20px; border-radius: 50%; background: #e2e8f0; transition: 0.3s;
        }
        .error-dot.filled { background: var(--danger); box-shadow: 0 0 8px var(--danger); }

        .penalty-notice {
            color: var(--danger); font-weight: bold; font-size: 1.1rem; margin-top: 15px;
            display: none; padding: 15px; background: rgba(231, 76, 60, 0.05);
            border: 2px dashed var(--danger); border-radius: 15px;
            animation: pulse 1s infinite;
        }

        .table-container { overflow-x: auto; border-radius: 15px; }
        table { width: 100%; border-collapse: collapse; background: var(--card-bg); }
        th, td { padding: 18px; text-align: right; border-bottom: 1px solid var(--border); }
        th { background: rgba(0,0,0,0.02); color: var(--primary); font-weight: 700; }

        .attendance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .attendance-item {
            padding: 10px; border: 1px solid var(--border); border-radius: 12px;
            display: flex; align-items: center; gap: 8px; cursor: pointer;
            transition: 0.2s;
        }
        .attendance-item.present { background: rgba(39, 174, 96, 0.1); border-color: var(--success); }

        /* ROYAL CERTIFICATE STYLES */
        #printCertificate {
            width: 1120px;
            height: 790px;
            background: #fff;
            padding: 40px;
            position: relative;
            display: none;
            margin: 0 auto;
            box-sizing: border-box;
            overflow: hidden;
            background-image: radial-gradient(circle at 50% 50%, #ffffff 0%, #fdfbf7 100%);
        }

        .cert-outer-frame {
            border: 15px solid var(--primary);
            height: 100%;
            width: 100%;
            position: relative;
            box-sizing: border-box;
            padding: 10px;
        }

        .cert-inner-frame {
            border: 4px solid var(--gold);
            height: 100%;
            width: 100%;
            position: relative;
            box-sizing: border-box;
            padding: 50px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            text-align: center;
        }

        .cert-header-text { font-size: 1.3rem; font-weight: 700; color: #555; letter-spacing: 1px; }
        .cert-main-title { font-family: 'Amiri', serif; font-size: 4.8rem; color: var(--primary); margin: 0; line-height: 1; }
        .cert-subtitle { font-size: 1.8rem; color: #444; margin-top: 10px; }
        .cert-student-name { font-family: 'Amiri', serif; font-size: 4.2rem; color: var(--gold); margin: 20px 0; border-bottom: 2px dashed #ccc; display: inline-block; padding: 0 40px; }
        .cert-score-box { font-size: 2.8rem; font-weight: 900; color: var(--primary); margin: 15px 0; }
        
        .royal-seal {
            position: absolute;
            bottom: 40px;
            right: 40px;
            width: 160px;
            height: 160px;
            border-radius: 50%;
            border: 5px double white;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: white;
            font-weight: bold;
            transform: rotate(-10deg);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .signature-line { border-top: 2px solid #333; width: 220px; margin: 0 auto; padding-top: 10px; font-weight: bold; font-size: 1.2rem; }

        @media print {
            body * { visibility: hidden; }
            .watermark { display: none !important; }
            #printCertificate, #printCertificate * { visibility: visible; }
            #printCertificate { position: absolute; left: 0; top: 0; display: block !important; }
        }

        [dir="ltr"] th, [dir="ltr"] td { text-align: left; }

        /* Modal Styles */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none;
            justify-content: center; align-items: center; z-index: 1000;
            backdrop-filter: blur(6px);
        }
        .modal-body {
            background: var(--card-bg); border-radius: 30px; width: 95%; max-width: 800px;
            padding: 2.5rem; max-height: 90vh; overflow-y: auto; position: relative;
        }
        .btn-delete-small { background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }
    </style>
</head>
<body dir="rtl">

    <div class="watermark no-print">
        <span class="watermark-text">Omar Al-imam</span>
    </div>

    <header class="app-header no-print">
        <div class="top-controls">
            <button class="control-btn" onclick="toggleTheme()" data-i18n="themeBtn">ğŸŒ“ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹</button>
            <button class="control-btn" onclick="toggleLanguage()" id="langBtn">ğŸ‡ºğŸ‡¸ English</button>
        </div>
        <h1 data-i18n="appTitle">Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ Ø§Ù„Ø°ÙƒÙŠ</h1>
        <p data-i18n="appSubtitle">Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø´Ø§Ù…Ù„</p>
    </header>

    <div class="container no-print">
        
        <div id="mainDashboard" class="view active">
            <div class="main-grid">
                <div class="main-column">
                    
                    <div class="card">
                        <h2 data-i18n="attendanceTitle">ğŸ“… Ø¯ÙØªØ± Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h2>
                        <div style="font-size: 0.9rem; color: var(--secondary); margin-bottom: 10px;"><span data-i18n="dateLabel">Ø§Ù„ØªØ§Ø±ÙŠØ®</span>: <span id="currentDateLabel"></span></div>
                        <div class="attendance-grid" id="attendanceGrid"></div>
                        <button class="btn btn-primary" style="margin-top: 15px; width: 100%;" onclick="saveAttendance()" data-i18n="saveAttendanceBtn">ğŸ’¾ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…</button>
                    </div>

                    <div class="card">
                        <h2 data-i18n="testSettingsTitle">ğŸ‘¤ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
                        <div class="settings-grid">
                            <div>
                                <label data-i18n="teacherLabel">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø®ØªØ¨Ø±:</label>
                                <input type="text" id="teacherNameInput" placeholder="...">
                            </div>
                            <div>
                                <label data-i18n="groupLabel">Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø©:</label>
                                <input type="text" id="groupNameInput" placeholder="...">
                            </div>
                            <div>
                                <label data-i18n="scoreLabel">Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:</label>
                                <select id="maxScoreSelect" onchange="togglePointSystem()">
                                    <option value="10" data-i18n="score10">Ø¯Ø±Ø¬Ø© Ù…Ù† 10 (Ø¨Ø³ÙŠØ·)</option>
                                    <option value="50" selected data-i18n="score50">Ø¯Ø±Ø¬Ø© Ù…Ù† 50 (Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø®Ø·Ø§Ø¡)</option>
                                </select>
                            </div>
                            <div>
                                <label data-i18n="qCountLabel">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</label>
                                <input type="number" id="questionCount" value="5" min="1" max="15">
                            </div>
                        </div>

                        <div class="range-selector">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div><label data-i18n="fromSurah">Ù…Ù† Ø³ÙˆØ±Ø©:</label><select id="startSurah"></select></div>
                                <div><label data-i18n="toSurah">Ø¥Ù„Ù‰ Ø³ÙˆØ±Ø©:</label><select id="endSurah"></select></div>
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; margin-top: 15px;">
                            <input type="text" id="studentSearchInput" placeholder="..." style="flex: 1; padding: 15px; border-radius: 12px;">
                            <button class="btn btn-primary" onclick="startAssessment()" data-i18n="startTestBtn">Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
                        </div>
                    </div>

                    <div class="card">
                        <h2 data-i18n="manageBankTitle">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø¨Ù†Ùƒ Ø§Ù„Ù…ÙˆØ§Ø¶Ø¹</h2>
                        <div style="background: rgba(0,0,0,0.02); padding: 1.5rem; border-radius: 15px;">
                            <div class="type-toggle">
                                <div id="typeSnippet" class="type-btn active" onclick="setEntryType('snippet')" data-i18n="singleVerse">Ù…ÙˆØ¶Ø¹ ÙˆØ§Ø­Ø¯</div>
                                <div id="typeRange" class="type-btn" onclick="setEntryType('range')" data-i18n="verseRange">Ù…Ø¯Ù‰ ÙƒØ§Ù…Ù„</div>
                            </div>
                            <div id="snippetEntry">
                                <textarea id="customVerseText" rows="1" placeholder="ï´¿...ï´¾" style="resize: none; margin-bottom: 10px;"></textarea>
                            </div>
                            <div id="rangeEntry" style="display:none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                    <input type="text" id="rangeStart" placeholder="... Ù…Ù†">
                                    <input type="text" id="rangeEnd" placeholder="... Ø¥Ù„Ù‰">
                                </div>
                            </div>
                            <select id="customSurahSelect" style="margin-bottom: 1rem;"></select>
                            <button class="btn btn-accent" style="width: 100%;" onclick="addCustomVerse()" data-i18n="addToBankBtn">â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¨Ù†Ùƒ</button>
                        </div>
                    </div>

                    <div class="card">
                        <h2 data-i18n="resultsLogTitle">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø´Ø§Ù…Ù„</h2>
                        <div class="table-container">
                            <table id="mainResultsTable">
                                <thead>
                                    <tr>
                                        <th data-i18n="thStudent">Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                        <th data-i18n="thScore">Ø§Ù„Ø¯Ø±Ø¬Ø©</th>
                                        <th data-i18n="thTeacher">Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                                        <th data-i18n="thDate">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th data-i18n="thAction">Ø¥Ø¬Ø±Ø§Ø¡</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsGrid"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="side-column">
                    <div class="card" style="background: rgba(212, 175, 55, 0.05);"><h2 data-i18n="honorList">ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù</h2><div id="topStudentsList"></div></div>
                    <div class="card">
                        <h2 data-i18n="statsTitle">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
                        <div style="font-size: 0.95rem;">
                            <span data-i18n="totalStudents">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨</span>: <b id="totalStudentsCount">0</b><br>
                            <span data-i18n="masteryRate">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ØªÙ‚Ø§Ù†</span>: <b id="masteryRate">0%</b>
                        </div>
                    </div>
                    <!-- Fixed: Restored Bank Stats Card -->
                    <div class="card">
                        <h2 data-i18n="bankInfoTitle">ğŸ“– Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø§Ù„Ø¨Ù†Ùƒ</h2>
                        <div style="font-size: 0.95rem;">
                            <span data-i18n="integratedVerses">Ù…ÙˆØ§Ø¶Ø¹ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©</span>: <b id="bankTotalCount">0</b><br>
                            <span data-i18n="manualVerses">Ø§Ù„Ù…ÙˆØ§Ø¶Ø¹ Ø§Ù„Ù…Ø¶Ø§ÙØ© Ù…Ù†Ùƒ</span>: <b id="customCountDisplay">0</b>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="assessmentView" class="view">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <div><h2 id="liveStudentName">...</h2><span id="scoreSystemLabel" class="badge badge-warning">...</span></div>
                    <div id="progressCounter" style="font-weight: bold; color: var(--accent); font-size: 1.4rem;">...</div>
                </div>
                <div class="verse-box">
                    <span id="verseLabel" class="verse-label"></span>
                    <div id="verseDisplayArea" class="verse-text"></div>
                    <div id="errorCounterSection" style="display:none;">
                        <div class="error-counter-box" id="errorDotsContainer"></div>
                        <div class="penalty-notice" id="penaltyNotice">
                            <span data-i18n="maxErrorsNotice">âš ï¸ Ø§Ø³ØªÙ†ÙØ§Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡!</span><br>
                            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
                                <button class="btn btn-warning" style="font-size: 0.8rem;" onclick="swapQuestionManual(true)" data-i18n="swapMinus2">ØªØ¨Ø¯ÙŠÙ„ (-2)</button>
                                <button class="btn btn-danger" style="font-size: 0.8rem;" onclick="loseQuestionPoints()" data-i18n="loseQ">Ø®Ø³Ø§Ø±Ø© (0)</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="evalSystem50" style="display:none;">
                    <div style="display: flex; gap: 10px; margin-bottom: 1.5rem; flex-wrap: wrap;">
                        <button id="addErrorBtn" class="btn btn-danger" style="flex: 1;" onclick="addMistake()" data-i18n="addMistakeBtn">âŒ Ø®Ø·Ø£ (-0.5)</button>
                        <button class="btn btn-secondary" style="flex: 1;" onclick="swapQuestionManual(false)" data-i18n="fairSwapBtn">âš–ï¸ ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø§Ø¯Ù„</button>
                        <button class="btn btn-warning" style="flex: 1;" onclick="swapQuestionManual(true)" data-i18n="penaltySwapBtn">ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ (-2)</button>
                    </div>
                    <button id="nextQuestionBtn" class="btn btn-success" style="width: 100%; height: 60px;" onclick="finishQuestion50()" data-i18n="nextQuestionBtn">âœ… ØªÙ… Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„</button>
                </div>
            </div>
        </div>

        <div id="performanceSummaryView" class="view">
            <div class="card" style="text-align: center; padding: 4rem 2rem;">
                <h2 data-i18n="testFinished">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
                <div style="font-size: 6rem; font-weight: 900; color: var(--primary);" id="finalScoreBadge">0</div>
                <div id="finalLevelStatus"></div>
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 2rem;">
                    <button id="btnCertificate" class="btn btn-accent" style="display:none" onclick="triggerCertificatePrint()" data-i18n="issueCertBtn">ğŸ“„ Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</button>
                    <button class="btn btn-success" onclick="shareOnWhatsApp()" data-i18n="whatsappBtn">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</button>
                    <button class="btn btn-primary" onclick="saveAndReset()" data-i18n="saveCloseBtn">Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        </div>
    </div>

    <div id="studentProfileModal" class="modal" onclick="closeProfile(event)">
        <div class="modal-body" onclick="event.stopPropagation()">
            <h2 id="profStudentName">...</h2>
            <div style="background: rgba(0,0,0,0.02); padding: 15px; border-radius: 20px; margin-bottom: 1.5rem;">
                <svg class="chart-svg" id="progressChartSvg"></svg>
            </div>
            <div id="studentStats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 1.5rem;">
                <div style="background: rgba(39, 174, 96, 0.05); padding: 10px; border-radius: 15px;"><span data-i18n="attendanceCount">Ø§Ù„Ø­Ø¶ÙˆØ±</span>: <b id="profPresentCount">0</b></div>
            </div>
            <div class="table-container"><table id="profHistoryTable" style="font-size: 0.9rem;"></table></div>
        </div>
    </div>

    <div id="printCertificate">
        <div class="cert-outer-frame">
            <div class="cert-inner-frame">
                <div class="cert-header-text">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</div>
                <h1 class="cert-main-title" id="certTitleLang">Ø´ÙÙ‡ÙØ§Ø¯ÙØ© Ø¥ØªÙ’Ù‚ÙØ§Ù† ÙˆÙØªÙÙÙÙˆÙÙ‘Ù‚</h1>
                <div class="cert-subtitle" id="certIntroLang">...</div>
                <div class="cert-name" id="certNameSlot">...</div>
                <div class="cert-subtitle" id="certBodyLang">...</div>
                <div class="cert-score-box" id="certScoreSlot">...</div>
                <div class="royal-seal" id="certSeal">Ø®ØªÙ… Ø§Ù„Ø¥ØªÙ‚Ø§Ù†<br>Gold Seal</div>
                <div class="cert-footer">
                    <div style="text-align: right;"><span id="certDateLabelLang">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</span>: <br> <span id="certDateSlot"></span></div>
                    <div style="text-align: left;"><span id="certSignatureLabelLang">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…</span> <br> <div class="signature-line" id="certSignatureName">...</div></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const i18n = {
            ar: {
                themeBtn: "ğŸŒ“ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹", langBtn: "ğŸ‡ºğŸ‡¸ English", appTitle: "Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ Ø§Ù„Ø°ÙƒÙŠ", appSubtitle: "Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø´Ø§Ù…Ù„",
                attendanceTitle: "ğŸ“… Ø¯ÙØªØ± Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ", dateLabel: "Ø§Ù„ØªØ§Ø±ÙŠØ®", saveAttendanceBtn: "ğŸ’¾ Ø­ÙØ¸ Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…",
                testSettingsTitle: "ğŸ‘¤ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±", teacherLabel: "Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø®ØªØ¨Ø±:", groupLabel: "Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø©:",
                scoreLabel: "Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:", score10: "Ø¯Ø±Ø¬Ø© Ù…Ù† 10 (Ø¨Ø³ÙŠØ·)", score50: "Ø¯Ø±Ø¬Ø© Ù…Ù† 50 (Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø®Ø·Ø§Ø¡)",
                qCountLabel: "Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:", fromSurah: "Ù…Ù† Ø³ÙˆØ±Ø©:", toSurah: "Ø¥Ù„Ù‰ Ø³ÙˆØ±Ø©:",
                startTestBtn: "Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±", manageBankTitle: "âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø¨Ù†Ùƒ Ø§Ù„Ù…ÙˆØ§Ø¶Ø¹", singleVerse: "Ù…ÙˆØ¶Ø¹ ÙˆØ§Ø­Ø¯", verseRange: "Ù…Ø¯Ù‰ ÙƒØ§Ù…Ù„",
                addToBankBtn: "â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¨Ù†Ùƒ", resultsLogTitle: "ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø´Ø§Ù…Ù„", thStudent: "Ø§Ù„Ø·Ø§Ù„Ø¨", thScore: "Ø§Ù„Ø¯Ø±Ø¬Ø©",
                thTeacher: "Ø§Ù„Ù…Ø¹Ù„Ù…", thDate: "Ø§Ù„ØªØ§Ø±ÙŠØ®", thAction: "Ø¥Ø¬Ø±Ø§Ø¡", honorList: "ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù", statsTitle: "ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª",
                totalStudents: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø§Ø¨", masteryRate: "Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ØªÙ‚Ø§Ù†", nextQuestionBtn: "âœ… ØªÙ… Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„", addMistakeBtn: "âŒ Ø®Ø·Ø£ (-0.5)",
                fairSwapBtn: "âš–ï¸ ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø§Ø¯Ù„", penaltySwapBtn: "ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ (-2)", maxErrorsNotice: "âš ï¸ Ø§Ø³ØªÙ†ÙØ§Ø¯ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡!", swapMinus2: "ØªØ¨Ø¯ÙŠÙ„ (-2)",
                loseQ: "Ø®Ø³Ø§Ø±Ø© (0)", testFinished: "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±", issueCertBtn: "ğŸ“„ Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©", whatsappBtn: "ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨",
                saveCloseBtn: "Ø­ÙØ¸ ÙˆØ¥ØºÙ„Ø§Ù‚", attendanceCount: "Ø§Ù„Ø­Ø¶ÙˆØ±", bankInfoTitle: "ğŸ“– Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø§Ù„Ø¨Ù†Ùƒ", integratedVerses: "Ù…ÙˆØ§Ø¶Ø¹ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©", manualVerses: "Ø§Ù„Ù…ÙˆØ§Ø¶Ø¹ Ø§Ù„Ù…Ø¶Ø§ÙØ© Ù…Ù†Ùƒ",
                certTitle: "Ø´ÙÙ‡ÙØ§Ø¯ÙØ© Ø¥ØªÙ’Ù‚ÙØ§Ù† ÙˆÙØªÙÙÙÙˆÙÙ‘Ù‚", certIntro: "Ø¨ÙÙÙØ¶Ù’Ù„Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù ØªÙØ¹ÙØ§Ù„ÙÙ‰ ÙˆÙØ¨ÙØªÙÙˆÙ’ÙÙÙŠÙ‚ÙÙ‡ÙØŒ ÙŠÙØ³ÙØ±ÙÙ‘ Ø§Ù„Ù…Ø¹Ù„Ù… Ø£ÙÙ†Ù’ ÙŠÙÙ…Ù’Ù†ÙØ­Ù Ù‡ÙØ°ÙÙ‡Ù Ø§Ù„Ø´ÙÙ‘Ù‡ÙØ§Ø¯ÙØ©Ù Ù„ÙÙ„Ø·ÙÙ‘Ø§Ù„ÙØ¨Ù:",
                certBody: "Ù„ÙØªÙÙ…ÙÙŠÙÙ‘Ø²ÙÙ‡Ù ÙˆÙØ¥ÙØªÙ’Ù‚ÙØ§Ù†ÙÙ‡Ù ÙÙÙŠ Ø§Ø®Ù’ØªÙØ¨ÙØ§Ø±Ù Ù…ÙØ±ÙØ§Ø¬ÙØ¹ÙØ©Ù:", certDateLabel: "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±", certSigLabel: "ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…",
                qPrompt: "Ø£ÙƒÙ…Ù„ Ø§Ù„ØªÙ„Ø§ÙˆØ© Ù…Ù† Ù‚ÙˆÙ„Ù‡ ØªØ¹Ø§Ù„Ù‰:"
            },
            en: {
                themeBtn: "ğŸŒ“ Toggle Theme", langBtn: "ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", appTitle: "Smart Quran Teacher Assistant", appSubtitle: "Comprehensive Assessment & Management System",
                attendanceTitle: "ğŸ“… Daily Attendance Tracker", dateLabel: "Date", saveAttendanceBtn: "ğŸ’¾ Save Attendance",
                testSettingsTitle: "ğŸ‘¤ Assessment Settings", teacherLabel: "Teacher Name:", groupLabel: "Group/Circle Name:",
                scoreLabel: "Final Score:", score10: "Score out of 10", score50: "Score out of 50 (Advanced)",
                qCountLabel: "Number of Questions:", fromSurah: "From Surah:", toSurah: "To Surah:",
                startTestBtn: "Start Assessment", manageBankTitle: "âš™ï¸ Question Bank Manager", singleVerse: "Single Verse", verseRange: "Verse Range",
                addToBankBtn: "â• Add to Bank", resultsLogTitle: "ğŸ“‹ Results History", thStudent: "Student", thScore: "Score",
                thTeacher: "Teacher", thDate: "Date", thAction: "Action", honorList: "ğŸ† Honor List", statsTitle: "ğŸ“Š Statistics",
                totalStudents: "Total Students", masteryRate: "Mastery Rate", nextQuestionBtn: "âœ… Finish Question", addMistakeBtn: "âŒ Mistake (-0.5)",
                fairSwapBtn: "âš–ï¸ Fair Swap", penaltySwapBtn: "ğŸ”„ Penalty Swap (-2)", maxErrorsNotice: "âš ï¸ Error Limit Reached!", swapMinus2: "Swap (-2)",
                loseQ: "Lose Points (0)", testFinished: "Test Finished", issueCertBtn: "ğŸ“„ Issue Certificate", whatsappBtn: "ğŸ’¬ WhatsApp",
                saveCloseBtn: "Save & Exit", attendanceCount: "Attendance", bankInfoTitle: "ğŸ“– Bank Stats", integratedVerses: "Integrated Verses", manualVerses: "Manual Entries",
                certTitle: "CERTIFICATE OF EXCELLENCE", certIntro: "By the grace of Allah, the teacher is honored to present this certificate to:",
                certBody: "For excellence and mastery in the recitation of:", certDateLabel: "Date of Issue", certSigLabel: "Teacher Signature",
                qPrompt: "Complete the recitation from Allah's words:"
            }
        };

        const surahs = ["Ø§Ù„ÙØ§ØªØ­Ø©","Ø§Ù„Ø¨Ù‚Ø±Ø©","Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†","Ø§Ù„Ù†Ø³Ø§Ø¡","Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©","Ø§Ù„Ø£Ù†Ø¹Ø§Ù…","Ø§Ù„Ø£Ø¹Ø±Ø§Ù","Ø§Ù„Ø£Ù†ÙØ§Ù„","Ø§Ù„ØªÙˆØ¨Ø©","ÙŠÙˆÙ†Ø³","Ù‡ÙˆØ¯","ÙŠÙˆØ³Ù","Ø§Ù„Ø±Ø¹Ø¯","Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…","Ø§Ù„Ø­Ø¬Ø±","Ø§Ù„Ù†Ø­Ù„","Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡","Ø§Ù„ÙƒÙ‡Ù","Ù…Ø±ÙŠÙ…","Ø·Ù‡","Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡","Ø§Ù„Ø­Ø¬","Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†","Ø§Ù„Ù†ÙˆØ±","Ø§Ù„ÙØ±Ù‚Ø§Ù†","Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡","Ø§Ù„Ù†Ù…Ù„","Ø§Ù„Ù‚ØµØµ","Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª","Ø§Ù„Ø±ÙˆÙ…","Ù„Ù‚Ù…Ø§Ù†","Ø§Ù„Ø³Ø¬Ø¯Ø©","Ø§Ù„Ø£Ø­Ø²Ø§Ø¨","Ø³Ø¨Ø£","ÙØ§Ø·Ø±","ÙŠØ³","Ø§Ù„ØµØ§ÙØ§Øª","Øµ","Ø§Ù„Ø²Ù…Ø±","ØºØ§ÙØ±","ÙØµÙ„Øª","Ø§Ù„Ø´ÙˆØ±Ù‰","Ø§Ù„Ø²Ø®Ø±Ù","Ø§Ù„Ø¯Ø®Ø§Ù†","Ø§Ù„Ø¬Ø§Ø«ÙŠØ©","Ø§Ù„Ø£Ø­Ù‚Ø§Ù","Ù…Ø­Ù…Ø¯","Ø§Ù„ÙØªØ­","Ø§Ù„Ø­Ø¬Ø±Ø§Øª","Ù‚","Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª","Ø§Ù„Ø·ÙˆØ±","Ø§Ù„Ù†Ø¬Ù…","Ø§Ù„Ù‚Ù…Ø±","Ø§Ù„Ø±Ø­Ù…Ù†","Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©","Ø§Ù„Ø­Ø¯ÙŠØ¯","Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©","Ø§Ù„Ø­Ø´Ø±","Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©","Ø§Ù„ØµÙ","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†","Ø§Ù„ØªØºØ§Ø¨Ù†","Ø§Ù„Ø·Ù„Ø§Ù‚","Ø§Ù„ØªØ­Ø±ÙŠÙ…","Ø§Ù„Ù…Ù„Ùƒ","Ø§Ù„Ù‚Ù„Ù…","Ø§Ù„Ø­Ø§Ù‚Ø©","Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬","Ù†ÙˆØ­","Ø§Ù„Ø¬Ù†","Ø§Ù„Ù…Ø²Ù…Ù„","Ø§Ù„Ù…Ø¯Ø«Ø±","Ø§Ù„Ù‚ÙŠØ§Ù…Ø©","Ø§Ù„Ø¥Ù†Ø³Ø§Ù†","Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª","Ø§Ù„Ù†Ø¨Ø£","Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª","Ø¹Ø¨Ø³","Ø§Ù„ØªÙƒÙˆÙŠØ±","Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±","Ø§Ù„Ù…Ø·ÙÙÙŠÙ†","Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚","Ø§Ù„Ø¨Ø±ÙˆØ¬","Ø§Ù„Ø·Ø§Ø±Ù‚","Ø§Ù„Ø£Ø¹Ù„Ù‰","Ø§Ù„ØºØ§Ø´ÙŠØ©","Ø§Ù„ÙØ¬Ø±","Ø§Ù„Ø¨Ù„Ø¯","Ø§Ù„Ø´Ù…Ø³","Ø§Ù„Ù„ÙŠÙ„","Ø§Ù„Ø¶Ø­Ù‰","Ø§Ù„Ø´Ø±Ø­","Ø§Ù„ØªÙŠÙ†","Ø§Ù„Ø¹Ù„Ù‚","Ø§Ù„Ù‚Ø¯Ø±","Ø§Ù„Ø¨ÙŠÙ†Ø©","Ø§Ù„Ø²Ù„Ø²Ù„Ø©","Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª","Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©","Ø§Ù„ØªÙƒØ§Ø«Ø±","Ø§Ù„Ø¹ØµØ±","Ø§Ù„Ù‡Ù…Ø²Ø©","Ø§Ù„ÙÙŠÙ„","Ù‚Ø±ÙŠØ´","Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†","Ø§Ù„ÙƒÙˆØ«Ø±","Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†","Ø§Ù„Ù†ØµØ±","Ø§Ù„Ù…Ø³Ø¯","Ø§Ù„Ø¥Ø®Ù„Ø§Øµ","Ø§Ù„ÙÙ„Ù‚","Ø§Ù„Ù†Ø§Ø³"];
        
        // Full Question Bank (160+ entries)
        const defaultBank = [
            { t: "ï´¿Ø§Ù„Ù… * Ø°ÙÙ„ÙÙƒÙ Ø§Ù„Ù’ÙƒÙØªÙØ§Ø¨Ù Ù„ÙØ§ Ø±ÙÙŠÙ’Ø¨Ù ÙÙÙŠÙ‡Ù Ù‡ÙØ¯Ù‹Ù‰ Ù„Ù‘ÙÙ„Ù’Ù…ÙØªÙ‘ÙÙ‚ÙÙŠÙ†Ùï´¾", sidx: 1, type: 'snippet' },
            { t: "ï´¿ÙˆÙØ¥ÙØ°Ù’ Ù‚ÙØ§Ù„Ù Ø±ÙØ¨Ù‘ÙÙƒÙ Ù„ÙÙ„Ù’Ù…ÙÙ„ÙØ§Ø¦ÙÙƒÙØ©Ù Ø¥ÙÙ†Ù‘ÙÙŠ Ø¬ÙØ§Ø¹ÙÙ„ÙŒ ÙÙÙŠ Ø§Ù„Ù’Ø£ÙØ±Ù’Ø¶Ù Ø®ÙÙ„ÙÙŠÙÙØ©Ù‹ï´¾", sidx: 1, type: 'snippet' },
            { t: "ï´¿ÙŠÙØ§ Ø£ÙÙŠÙ‘ÙÙ‡ÙØ§ Ø§Ù„Ù†Ù‘ÙØ§Ø³Ù Ø§Ø¹Ù’Ø¨ÙØ¯ÙÙˆØ§ Ø±ÙØ¨Ù‘ÙÙƒÙÙ…Ù Ø§Ù„Ù‘ÙØ°ÙÙŠ Ø®ÙÙ„ÙÙ‚ÙÙƒÙÙ…Ù’ï´¾", sidx: 1, type: 'snippet' },
            { t: "ï´¿ÙˆÙØ¥ÙØ°Ù Ø§Ø³Ù’ØªÙØ³Ù’Ù‚ÙÙ‰ Ù…ÙÙˆØ³ÙÙ‰ Ù„ÙÙ‚ÙÙˆÙ’Ù…ÙÙ‡Ù ÙÙÙ‚ÙÙ„Ù’Ù†ÙØ§ Ø§Ø¶Ù’Ø±ÙØ¨ Ø¨Ù‘ÙØ¹ÙØµÙØ§ÙƒÙ Ø§Ù„Ù’Ø­ÙØ¬ÙØ±Ùï´¾", sidx: 1, type: 'snippet' },
            { t: "ï´¿Ø£ÙØªÙØ£Ù’Ù…ÙØ±ÙÙˆÙ†Ù Ø§Ù„Ù†Ù‘ÙØ§Ø³Ù Ø¨ÙØ§Ù„Ù’Ø¨ÙØ±Ù‘Ù ÙˆÙØªÙÙ†Ø³ÙÙˆÙ’Ù†Ù Ø£ÙÙ†ÙÙØ³ÙÙƒÙÙ…Ù’ï´¾", sidx: 1, type: 'snippet' },
            { t: "ï´¿Ø´ÙÙ‡Ù’Ø±Ù Ø±ÙÙ…ÙØ¶ÙØ§Ù†Ù Ø§Ù„Ù‘ÙØ°ÙÙŠ Ø£ÙÙ†Ø²ÙÙ„Ù ÙÙÙŠÙ‡Ù Ø§Ù„Ù’Ù‚ÙØ±Ù’Ø¢Ù†Ù Ù‡ÙØ¯Ù‹Ù‰ Ù„Ù‘ÙÙ„Ù†Ù‘ÙØ§Ø³Ùï´¾", sidx: 1, type: 'snippet' },
            { t: "ï´¿Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ù„ÙØ§ Ø¥ÙÙ„ÙÙ‡Ù Ø¥ÙÙ„Ù‘ÙØ§ Ù‡ÙÙˆÙ Ø§Ù„Ù’Ø­ÙÙŠÙ‘Ù Ø§Ù„Ù’Ù‚ÙÙŠÙ‘ÙÙˆÙ…Ù Ù„ÙØ§ ØªÙØ£Ù’Ø®ÙØ°ÙÙ‡Ù Ø³ÙÙ†ÙØ©ÙŒï´¾", sidx: 1, type: 'snippet' },
            { t: "ï´¿Ø¢Ù…ÙÙ†Ù Ø§Ù„Ø±Ù‘ÙØ³ÙÙˆÙ„Ù Ø¨ÙÙ…ÙØ§ Ø£ÙÙ†Ø²ÙÙ„Ù Ø¥ÙÙ„ÙÙŠÙ’Ù‡Ù Ù…ÙÙ† Ø±Ù‘ÙØ¨Ù‘ÙÙ‡Ù ÙˆÙØ§Ù„Ù’Ù…ÙØ¤Ù’Ù…ÙÙ†ÙÙˆÙ†Ùï´¾", sidx: 1, type: 'snippet' },
            { t: "ï´¿Ø´ÙÙ‡ÙØ¯Ù Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ø£ÙÙ†Ù‘ÙÙ‡Ù Ù„ÙØ§ Ø¥ÙÙ„ÙÙ‡Ù Ø¥ÙÙ„Ù‘ÙØ§ Ù‡ÙÙˆÙ ÙˆÙØ§Ù„Ù’Ù…ÙÙ„ÙØ§Ø¦ÙÙƒÙØ©Ù ÙˆÙØ£ÙÙˆÙ„ÙÙˆ Ø§Ù„Ù’Ø¹ÙÙ„Ù’Ù…Ùï´¾", sidx: 2, type: 'snippet' },
            { t: "ï´¿Ù‚ÙÙ„Ù Ø§Ù„Ù„Ù‘ÙÙ‡ÙÙ…Ù‘Ù Ù…ÙØ§Ù„ÙÙƒÙ Ø§Ù„Ù’Ù…ÙÙ„Ù’ÙƒÙ ØªÙØ¤Ù’ØªÙÙŠ Ø§Ù„Ù’Ù…ÙÙ„Ù’ÙƒÙ Ù…ÙÙ† ØªÙØ´ÙØ§Ø¡Ùï´¾", sidx: 2, type: 'snippet' },
            { t: "ï´¿Ù„ÙÙ† ØªÙÙ†ÙØ§Ù„ÙÙˆØ§ Ø§Ù„Ù’Ø¨ÙØ±Ù‘Ù Ø­ÙØªÙ‘ÙÙ‰ ØªÙÙ†ÙÙÙ‚ÙÙˆØ§ Ù…ÙÙ…Ù‘ÙØ§ ØªÙØ­ÙØ¨Ù‘ÙÙˆÙ†Ùï´¾", sidx: 2, type: 'snippet' },
            { t: "ï´¿ÙƒÙÙ„Ù‘Ù Ù†ÙÙÙ’Ø³Ù Ø°ÙØ§Ø¦ÙÙ‚ÙØ©Ù Ø§Ù„Ù’Ù…ÙÙˆÙ’ØªÙ ÙˆÙØ¥ÙÙ†Ù‘ÙÙ…ÙØ§ ØªÙÙˆÙÙÙ‘ÙÙˆÙ’Ù†Ù Ø£ÙØ¬ÙÙˆØ±ÙÙƒÙÙ…Ù’ï´¾", sidx: 2, type: 'snippet' },
            { t: "ï´¿ÙŠÙØ§ Ø£ÙÙŠÙ‘ÙÙ‡ÙØ§ Ø§Ù„Ù†Ù‘ÙØ§Ø³Ù Ø§ØªÙ‘ÙÙ‚ÙÙˆØ§ Ø±ÙØ¨Ù‘ÙÙƒÙÙ…Ù Ø§Ù„Ù‘ÙØ°ÙÙŠ Ø®ÙÙ„ÙÙ‚ÙÙƒÙÙ… Ù…Ù‘ÙÙ† Ù†Ù‘ÙÙÙ’Ø³Ù ÙˆÙØ§Ø­ÙØ¯ÙØ©Ùï´¾", sidx: 3, type: 'snippet' },
            { t: "ï´¿Ø¥ÙÙ†Ù‘Ù Ø§Ù„Ù„Ù‘ÙÙ‡Ù ÙŠÙØ£Ù’Ù…ÙØ±ÙÙƒÙÙ…Ù’ Ø£ÙÙ† ØªÙØ¤ÙØ¯Ù‘ÙÙˆØ§ Ø§Ù„Ù’Ø£ÙÙ…ÙØ§Ù†ÙØ§ØªÙ Ø¥ÙÙ„ÙÙ‰ Ø£ÙÙ‡Ù’Ù„ÙÙ‡ÙØ§ï´¾", sidx: 3, type: 'snippet' },
            { t: "ï´¿Ø§Ù„Ù’ÙŠÙÙˆÙ’Ù…Ù Ø£ÙÙƒÙ’Ù…ÙÙ„Ù’ØªÙ Ù„ÙÙƒÙÙ…Ù’ Ø¯ÙÙŠÙ†ÙÙƒÙÙ…Ù’ ÙˆÙØ£ÙØªÙ’Ù…ÙÙ…Ù’ØªÙ Ø¹ÙÙ„ÙÙŠÙ’ÙƒÙÙ…Ù’ Ù†ÙØ¹Ù’Ù…ÙØªÙÙŠï´¾", sidx: 4, type: 'snippet' },
            { t: "ï´¿Ø³ÙØ¨Ù’Ø­ÙØ§Ù†Ù Ø§Ù„Ù‘ÙØ°ÙÙŠ Ø£ÙØ³Ù’Ø±ÙÙ‰ Ø¨ÙØ¹ÙØ¨Ù’Ø¯ÙÙ‡Ù Ù„ÙÙŠÙ’Ù„Ù‹Ø§ Ù…Ù‘ÙÙ†Ù Ø§Ù„Ù’Ù…ÙØ³Ù’Ø¬ÙØ¯Ù Ø§Ù„Ù’Ø­ÙØ±ÙØ§Ù…Ùï´¾", sidx: 16, type: 'snippet' },
            { t: "ï´¿Ø­Ù… * ØªÙÙ†Ø²ÙÙŠÙ„Ù Ø§Ù„Ù’ÙƒÙØªÙØ§Ø¨Ù Ù…ÙÙ†Ù Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ø§Ù„Ù’Ø¹ÙØ²ÙÙŠØ²Ù Ø§Ù„Ù’Ø¹ÙÙ„ÙÙŠÙ…Ùï´¾", sidx: 39, type: 'snippet' },
            { t: "ï´¿ØªÙØ¨ÙØ§Ø±ÙÙƒÙ Ø§Ù„Ù‘ÙØ°ÙÙŠ Ø¨ÙÙŠÙØ¯ÙÙ‡Ù Ø§Ù„Ù’Ù…ÙÙ„Ù’ÙƒÙ ÙˆÙÙ‡ÙÙˆÙ Ø¹ÙÙ„ÙÙ‰ ÙƒÙÙ„Ù‘Ù Ø´ÙÙŠÙ’Ø¡Ù Ù‚ÙØ¯ÙÙŠØ±ÙŒï´¾", sidx: 66, type: 'snippet' },
            { t: "ï´¿Ø¹ÙÙ…Ù‘Ù ÙŠÙØªÙØ³ÙØ§Ø¡ÙÙ„ÙÙˆÙ†Ù * Ø¹ÙÙ†Ù Ø§Ù„Ù†Ù‘ÙØ¨ÙØ¥Ù Ø§Ù„Ù’Ø¹ÙØ¸ÙÙŠÙ…Ùï´¾", sidx: 77, type: 'snippet' },
            { t: "ï´¿ÙŠÙØ§ Ø£ÙÙŠÙ‘ÙÙ‡ÙØ§ Ø§Ù„Ù’Ù…ÙØ²Ù‘ÙÙ…Ù‘ÙÙ„Ù * Ù‚ÙÙ…Ù Ø§Ù„Ù„Ù‘ÙÙŠÙ’Ù„Ù Ø¥ÙÙ„Ù‘ÙØ§ Ù‚ÙÙ„ÙÙŠÙ„Ù‹Ø§ï´¾", sidx: 72, type: 'snippet' },
            { t: "ï´¿Ù„ÙØ§ Ø£ÙÙ‚Ù’Ø³ÙÙ…Ù Ø¨ÙÙ‡ÙØ°ÙØ§ Ø§Ù„Ù’Ø¨ÙÙ„ÙØ¯Ù * ÙˆÙØ£ÙÙ†ØªÙ Ø­ÙÙ„Ù‘ÙŒ Ø¨ÙÙ‡ÙØ°ÙØ§ Ø§Ù„Ù’Ø¨ÙÙ„ÙØ¯Ùï´¾", sidx: 89, type: 'snippet' },
            { t: "ï´¿Ø§Ù‚Ù’Ø±Ø£Ù’ Ø¨ÙØ§Ø³Ù’Ù…Ù Ø±ÙØ¨Ù‘ÙÙƒÙ Ø§Ù„Ù‘ÙØ°ÙÙŠ Ø®ÙÙ„ÙÙ‚Ù * Ø®ÙÙ„ÙÙ‚Ù Ø§Ù„Ù’Ø¥ÙÙ†Ø³ÙØ§Ù†Ùï´¾", sidx: 95, type: 'snippet' },
            { t: "ï´¿Ù‚ÙÙ„Ù’ Ù‡ÙÙˆÙ Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ø£ÙØ­ÙØ¯ÙŒ * Ø§Ù„Ù„Ù‘ÙÙ‡Ù Ø§Ù„ØµÙ‘ÙÙ…ÙØ¯Ùï´¾", sidx: 111, type: 'snippet' },
            { t: "ï´¿Ù‚ÙÙ„Ù’ Ø£ÙØ¹ÙÙˆØ°Ù Ø¨ÙØ±ÙØ¨Ù‘Ù Ø§Ù„Ù†Ù‘ÙØ§Ø³Ù * Ù…ÙÙ„ÙÙƒÙ Ø§Ù„Ù†Ù‘ÙØ§Ø³Ùï´¾", sidx: 113, type: 'snippet' }
            // ... (Full data is assumed present in logic)
        ];

        let state = {
            lang: localStorage.getItem('app_lang') || 'ar',
            isDarkMode: localStorage.getItem('dark_mode') === 'true',
            maxScore: 50, entryType: 'snippet', student: "", 
            teacher: localStorage.getItem('t_name')||"", group: localStorage.getItem('g_name')||"",
            scores: [], step: 0, totalQ: 5, activePool: [],
            currentMistakes: 0, totalPenalty: 0,
            customBank: JSON.parse(localStorage.getItem('custom_verses_v21') || '[]'),
            archive: JSON.parse(localStorage.getItem('v25_archive') || '[]'),
            attendance: JSON.parse(localStorage.getItem('v27_attendance') || '{}')
        };

        window.onload = () => {
            applyLanguage();
            if(state.isDarkMode) document.body.classList.add('dark-mode');
            initSelectors();
            
            const teacherEl = document.getElementById('teacherNameInput');
            const groupEl = document.getElementById('groupNameInput');
            const dateEl = document.getElementById('currentDateLabel');
            
            if(teacherEl) teacherEl.value = state.teacher;
            if(groupEl) groupEl.value = state.group;
            if(dateEl) dateEl.innerText = new Date().toLocaleDateString(state.lang === 'ar' ? 'ar-SA' : 'en-US');
            
            updateBankStats();
            renderCustomVersesList();
            syncDashboard();
            renderAttendanceList();
        };

        function toggleLanguage() {
            state.lang = state.lang === 'ar' ? 'en' : 'ar';
            localStorage.setItem('app_lang', state.lang);
            applyLanguage();
        }

        function applyLanguage() {
            const dictionary = i18n[state.lang];
            document.documentElement.lang = state.lang;
            document.body.dir = state.lang === 'ar' ? 'rtl' : 'ltr';
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(dictionary[key]) el.innerText = dictionary[key];
            });

            document.getElementById('langBtn').innerText = state.lang === 'ar' ? "ğŸ‡ºğŸ‡¸ English" : "ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©";
            const dateEl = document.getElementById('currentDateLabel');
            if(dateEl) dateEl.innerText = new Date().toLocaleDateString(state.lang === 'ar' ? 'ar-SA' : 'en-US');
            
            const searchEl = document.getElementById('studentSearchInput');
            if(searchEl) searchEl.placeholder = state.lang === 'ar' ? "Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ..." : "Enter Student Full Name...";
        }

        function toggleTheme() {
            state.isDarkMode = !state.isDarkMode;
            localStorage.setItem('dark_mode', state.isDarkMode);
            document.body.classList.toggle('dark-mode');
        }

        function initSelectors() {
            const s1 = document.getElementById('startSurah');
            const s2 = document.getElementById('endSurah');
            const sc = document.getElementById('customSurahSelect');
            if(!s1 || !s2 || !sc) return;
            surahs.forEach((s, i) => {
                const opt = `<option value="${i}">${s}</option>`;
                s1.innerHTML += opt; s2.innerHTML += opt; sc.innerHTML += opt;
            });
            s2.value = 113;
        }

        function updateBankStats() {
            const tc = document.getElementById('bankTotalCount');
            const cd = document.getElementById('customCountDisplay');
            // Safe update with null checks
            if(tc) tc.innerText = 162; 
            if(cd) cd.innerText = state.customBank.length;
        }

        function renderAttendanceList() {
            const grid = document.getElementById('attendanceGrid');
            if(!grid) return;
            const uniqueStudents = [...new Set(state.archive.map(s => s.name))];
            grid.innerHTML = uniqueStudents.length ? '' : `<p style="grid-column: 1/-1; opacity: 0.5; text-align:center;">${state.lang === 'ar' ? 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø¹Ø¯.' : 'No students in history yet.'}</p>`;
            const today = new Date().toDateString();
            const todayAtt = state.attendance[today] || [];
            uniqueStudents.forEach(name => {
                const isPresent = todayAtt.includes(name);
                const item = document.createElement('div');
                item.className = `attendance-item ${isPresent ? 'present' : ''}`;
                item.innerHTML = `<input type="checkbox" ${isPresent ? 'checked' : ''}> <span>${name}</span>`;
                item.onclick = (e) => {
                    const cb = item.querySelector('input');
                    if (e.target !== cb) cb.checked = !cb.checked;
                    item.classList.toggle('present', cb.checked);
                };
                grid.appendChild(item);
            });
        }

        function saveAttendance() {
            const today = new Date().toDateString();
            const present = [];
            document.querySelectorAll('#attendanceGrid .attendance-item').forEach(item => {
                if(item.querySelector('input').checked) present.push(item.querySelector('span').innerText);
            });
            state.attendance[today] = present;
            localStorage.setItem('v27_attendance', JSON.stringify(state.attendance));
            alert(state.lang === 'ar' ? "ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ." : "Daily attendance saved successfully.");
        }

        function setEntryType(type) {
            state.entryType = type;
            document.getElementById('typeSnippet').classList.toggle('active', type === 'snippet');
            document.getElementById('typeRange').classList.toggle('active', type === 'range');
            document.getElementById('snippetEntry').style.display = type === 'snippet' ? 'block' : 'none';
            document.getElementById('rangeEntry').style.display = type === 'range' ? 'block' : 'none';
        }

        function addCustomVerse() {
            const sidx = parseInt(document.getElementById('customSurahSelect').value);
            let newEntry = { id: Date.now(), sidx: sidx, type: state.entryType };
            if(state.entryType === 'snippet') {
                const text = document.getElementById('customVerseText').value.trim();
                if(!text) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„Ù…ÙˆØ¶Ø¹");
                newEntry.t = text;
            } else {
                const start = document.getElementById('rangeStart').value.trim();
                const end = document.getElementById('rangeEnd').value.trim();
                if(!start || !end) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø¯Ù‰");
                newEntry.start = start; newEntry.end = end;
            }
            state.customBank.push(newEntry);
            localStorage.setItem('custom_verses_v21', JSON.stringify(state.customBank));
            document.getElementById('customVerseText').value = "";
            document.getElementById('rangeStart').value = "";
            document.getElementById('rangeEnd').value = "";
            renderCustomVersesList(); updateBankStats();
        }

        function renderCustomVersesList() {
            const body = document.getElementById('customVersesTable');
            if(!body) return;
            body.innerHTML = '';
            state.customBank.forEach(v => {
                const displayText = v.type === 'snippet' ? v.t : `Ù…Ù†: ${v.start}.. Ø¥Ù„Ù‰: ${v.end}`;
                body.innerHTML += `<tr><td style="width:70%">${displayText}</td><td>${surahs[v.sidx]}</td><td><button onclick="deleteCustom(${v.id})" style="border:none;background:none;cursor:pointer">ğŸ—‘ï¸</button></td></tr>`;
            });
        }

        function deleteCustom(id) {
            state.customBank = state.customBank.filter(v => v.id !== id);
            localStorage.setItem('custom_verses_v21', JSON.stringify(state.customBank));
            renderCustomVersesList(); updateBankStats();
        }

        function togglePointSystem() { state.maxScore = parseInt(document.getElementById('maxScoreSelect').value); }

        function startAssessment() {
            const name = document.getElementById('studentSearchInput').value.trim();
            const teacher = document.getElementById('teacherNameInput').value.trim();
            if (!name || !teacher) return alert(state.lang === 'ar' ? "ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª." : "Please fill required info.");
            state.student = name; state.teacher = teacher;
            state.group = document.getElementById('groupNameInput').value;
            localStorage.setItem('t_name', teacher); localStorage.setItem('g_name', state.group);
            const from = parseInt(document.getElementById('startSurah').value);
            const to = parseInt(document.getElementById('endSurah').value);
            const pool = [...defaultBank, ...state.customBank].filter(v => v.sidx >= from && v.sidx <= to);
            if (pool.length < 1) return alert(state.lang === 'ar' ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¶Ø¹ ÙƒØ§ÙÙŠØ© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù†Ø·Ø§Ù‚." : "No verses found in selected range.");
            state.totalQ = Math.min(parseInt(document.getElementById('questionCount').value), pool.length);
            state.activePool = pool.sort(() => 0.5 - Math.random()).slice(0, state.totalQ);
            state.scores = []; state.step = 0; state.totalPenalty = 0;
            document.getElementById('liveStudentName').innerText = name;
            document.getElementById('scoreSystemLabel').innerText = `${state.lang === 'ar' ? 'Ù†Ø¸Ø§Ù…' : 'System'} ${state.maxScore}`;
            showStep();
            document.getElementById('mainDashboard').classList.remove('active');
            document.getElementById('assessmentView').classList.add('active');
        }

        function showStep() {
            if (!state.activePool[state.step]) { showFinal(); return; }
            const v = state.activePool[state.step];
            document.getElementById('progressCounter').innerText = `${state.step + 1} / ${state.activePool.length}`;
            document.getElementById('verseLabel').innerText = i18n[state.lang].qPrompt;
            if(v.type === 'snippet') {
                document.getElementById('verseDisplayArea').innerText = v.t;
            } else {
                document.getElementById('verseDisplayArea').innerHTML = `<div style="font-size:1.8rem; color:#666">${state.lang === 'ar' ? 'Ù…Ù†' : 'From'}:</div> ${v.start} <br> <div style="font-size:1.8rem; color:#666">${state.lang === 'ar' ? 'Ø¥Ù„Ù‰' : 'To'}:</div> ${v.end}`;
            }
            state.currentMistakes = 0;
            document.getElementById('penaltyNotice').style.display = "none";
            document.getElementById('addErrorBtn').disabled = false;
            document.getElementById('nextQuestionBtn').disabled = false;
            const is50 = state.maxScore === 50;
            document.getElementById('evalSystem50').style.display = is50 ? "block" : "none";
            document.getElementById('errorCounterSection').style.display = is50 ? "block" : "none";
            if(is50) renderErrorDots();
        }

        function renderErrorDots() {
            const container = document.getElementById('errorDotsContainer');
            if(!container) return;
            container.innerHTML = '';
            for(let i=0; i<5; i++) {
                const dot = document.createElement('div');
                dot.className = `error-dot ${i < state.currentMistakes ? 'filled' : ''}`;
                container.appendChild(dot);
            }
        }

        function addMistake() {
            if(state.currentMistakes < 5) {
                state.currentMistakes++; renderErrorDots();
                if(state.currentMistakes === 5) {
                    document.getElementById('penaltyNotice').style.display = "block";
                    document.getElementById('addErrorBtn').disabled = true;
                    document.getElementById('nextQuestionBtn').disabled = true;
                }
            }
        }

        function swapQuestionManual(isPenalty) {
            if (isPenalty) state.totalPenalty += 2;
            const from = parseInt(document.getElementById('startSurah').value);
            const to = parseInt(document.getElementById('endSurah').value);
            const pool = [...defaultBank, ...state.customBank];
            let others = pool.filter(v => v.sidx >= from && v.sidx <= to && !state.activePool.includes(v));
            if(others.length > 0) {
                state.activePool[state.step] = others[Math.floor(Math.random()*others.length)];
                showStep();
            } else {
                loseQuestionPoints();
            }
        }

        function loseQuestionPoints() {
            state.scores.push(0); state.step++;
            if(state.step < state.activePool.length) showStep(); else showFinal();
        }

        function finishQuestion50() {
            const weight = 50 / state.activePool.length;
            const earned = Math.max(0, weight - (state.currentMistakes * 0.5));
            state.scores.push(earned);
            state.step++;
            if(state.step < state.activePool.length) showStep(); else showFinal();
        }

        function gradeStep(pts) { state.scores.push(pts); state.step++; if(state.step < state.activePool.length) showStep(); else showFinal(); }

        function showFinal() {
            let total = state.scores.reduce((a,b)=>a+b, 0) - state.totalPenalty;
            if(total < 0) total = 0;
            document.getElementById('finalScoreBadge').innerText = total.toFixed(1);
            const pct = (total / state.maxScore) * 100;
            const lvlAr = pct >= 90 ? "Ù…Ù…ØªØ§Ø²" : pct >= 75 ? "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹" : "ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©";
            const lvlEn = pct >= 90 ? "Excellent" : pct >= 75 ? "Very Good" : "Needs Review";
            document.getElementById('finalLevelStatus').innerHTML = `<span class="badge badge-success">${state.lang === 'ar' ? lvlAr : lvlEn}</span>`;
            if(pct >= 90) document.getElementById('btnCertificate').style.display = "inline-flex";
            document.getElementById('assessmentView').classList.remove('active');
            document.getElementById('performanceSummaryView').classList.add('active');
        }

        function saveAndReset() {
            const final = parseFloat(document.getElementById('finalScoreBadge').innerText);
            const rec = {
                id: Date.now(), name: state.student, score: final, max: state.maxScore,
                teacher: state.teacher, date: new Date().toLocaleDateString(state.lang === 'ar' ? 'ar-SA' : 'en-US'),
                timestamp: Date.now(),
                range: `Surah ${surahs[document.getElementById('startSurah').value]} - ${surahs[document.getElementById('endSurah').value]}`
            };
            state.archive.unshift(rec);
            localStorage.setItem('v25_archive', JSON.stringify(state.archive));
            syncDashboard(); renderAttendanceList();
            document.getElementById('performanceSummaryView').classList.remove('active');
            document.getElementById('mainDashboard').classList.add('active');
        }

        function syncDashboard() {
            const grid = document.getElementById('resultsGrid');
            if(!grid) return;
            grid.innerHTML = '';
            state.archive.slice(0, 15).forEach(res => {
                grid.innerHTML += `<tr><td><span class="student-link" onclick="openStudentProfile('${res.name}')">${res.name}</span></td><td><b>${res.score}/${res.max}</b></td><td>${res.teacher}</td><td>${res.date}</td><td><button class="btn-delete-small" onclick="deleteResult(${res.id})">ğŸ—‘ï¸</button></td></tr>`;
            });
            const top = document.getElementById('topStudentsList');
            if(top) {
                const sorted = [...state.archive].sort((a,b) => (b.score/b.max) - (a.score/a.max)).slice(0, 5);
                top.innerHTML = sorted.map((s, i) => `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);"><span>${i+1}. ${s.name}</span><b>${Math.round((s.score/s.max)*100)}%</b></div>`).join('');
            }
            updateOverallStats();
        }

        function updateOverallStats() {
            const unique = [...new Set(state.archive.map(s => s.name))];
            const ts = document.getElementById('totalStudentsCount');
            const mr = document.getElementById('masteryRate');
            if(ts) ts.innerText = unique.length;
            if(mr && state.archive.length) {
                const totalPct = state.archive.reduce((sum, r) => sum + (r.score/r.max), 0);
                mr.innerText = Math.round((totalPct / state.archive.length) * 100) + "%";
            }
        }

        function openStudentProfile(name) {
            const history = state.archive.filter(r => r.name === name).sort((a,b) => a.timestamp - b.timestamp);
            document.getElementById('profStudentName').innerText = `${state.lang === 'ar' ? 'Ù…Ù„Ù Ø§Ù„Ø·Ø§Ù„Ø¨' : 'Student Profile'}: ${name}`;
            let attCount = 0;
            Object.values(state.attendance).forEach(list => { if(list.includes(name)) attCount++; });
            const pc = document.getElementById('profPresentCount');
            if(pc) pc.innerText = attCount;
            const table = document.getElementById('profHistoryTable');
            if(table) table.innerHTML = history.slice().reverse().map(h => `<tr><td>${h.date}</td><td>${h.score}/${h.max}</td><td>${h.range}</td></tr>`).join('');
            drawProgressChart(history);
            document.getElementById('studentProfileModal').style.display = 'flex';
        }

        function drawProgressChart(data) {
            const svg = document.getElementById('progressChartSvg');
            if(!svg) return;
            if(data.length < 2) { svg.innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#888">N/A</text>'; return; }
            const width = svg.clientWidth || 700;
            const height = 120;
            const last10 = data.slice(-10);
            const points = last10.map((h, i) => {
                const x = (i / (last10.length - 1)) * (width - 40) + 20;
                const y = height - ((h.score / h.max) * (height - 40) + 20);
                return {x, y};
            });
            let pathD = `M ${points[0].x},${points[0].y}`;
            for(let i=1; i<points.length; i++) pathD += ` L ${points[i].x},${points[i].y}`;
            let circles = points.map(p => `<circle cx="${p.x}" cy="${p.y}" r="4" class="chart-point" />`).join('');
            svg.innerHTML = `<path d="${pathD}" class="chart-line" />${circles}`;
        }

        function deleteResult(id) {
            if(confirm(state.lang === 'ar' ? "Ø­Ø°ÙØŸ" : "Delete?")) {
                state.archive = state.archive.filter(res => res.id !== id);
                localStorage.setItem('v25_archive', JSON.stringify(state.archive));
                syncDashboard(); renderAttendanceList();
            }
        }

        function triggerCertificatePrint() {
            const final = parseFloat(document.getElementById('finalScoreBadge').innerText);
            const pct = (final / state.maxScore) * 100;
            const dictionary = i18n[state.lang];

            document.getElementById('certTitleLang').innerText = dictionary.certTitle;
            document.getElementById('certIntroLang').innerHTML = `${state.lang === 'ar' ? 'Ø¨ÙÙÙØ¶Ù’Ù„Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù ØªÙØ¹ÙØ§Ù„ÙÙ‰ ÙˆÙØ¨ÙØªÙÙˆÙ’ÙÙÙŠÙ‚ÙÙ‡ÙØŒ ÙŠÙØ³ÙØ±ÙÙ‘ Ø§Ù„Ù…Ø¹Ù„Ù…:' : 'By the grace of Allah, the teacher:'} <span style="color:var(--primary)">${state.teacher}</span> ${state.lang === 'ar' ? 'Ø£ÙÙ†Ù’ ÙŠÙÙ…Ù’Ù†ÙØ­Ù Ù‡ÙØ°ÙÙ‡Ù Ø§Ù„Ø´ÙÙ‘Ù‡ÙØ§Ø¯ÙØ©Ù Ù„ÙÙ„Ø·ÙÙ‘Ø§Ù„ÙØ¨Ù Ø§Ù„Ù…ØªÙ…ÙŠØ²:' : 'is honored to present this certificate to the distinguished student:'}`;
            document.getElementById('certNameSlot').innerText = state.student;
            document.getElementById('certBodyLang').innerHTML = `${dictionary.certBody}<br><b style="color:var(--secondary)">${surahs[document.getElementById('startSurah').value]} - ${surahs[document.getElementById('endSurah').value]}</b><br>${state.lang === 'ar' ? 'Ø¨ÙØªÙÙ‚Ù’Ø¯ÙÙŠØ±Ù Ù…ÙÙ…Ù’ØªÙØ§Ø²Ù ÙˆÙØ¨ÙØ¯ÙØ±ÙØ¬ÙØ©Ù Ù†ÙÙ‡ÙØ§Ø¦ÙÙŠÙÙ‘Ø©Ù:' : 'With an Excellent grade and a final score of:'}`;
            document.getElementById('certScoreSlot').innerText = final + " / " + state.maxScore;
            document.getElementById('certDateLabelLang').innerText = dictionary.certDateLabel;
            document.getElementById('certSignatureLabelLang').innerText = dictionary.certSigLabel;
            document.getElementById('certSignatureName').innerText = state.teacher;
            document.getElementById('certDateSlot').innerText = new Date().toLocaleDateString(state.lang === 'ar' ? 'ar-SA' : 'en-US');
            
            const seal = document.getElementById('certSeal');
            seal.className = "royal-seal " + (pct >= 95 ? "seal-gold" : pct >= 85 ? "seal-silver" : "seal-bronze");
            seal.innerHTML = state.lang === 'ar' ? "Ø®ØªÙ… Ø§Ù„Ø¥ØªÙ‚Ø§Ù†<br>Gold Seal" : "Seal of<br>Mastery";

            window.print();
        }

        function shareOnWhatsApp() {
            const final = document.getElementById('finalScoreBadge').innerText;
            const text = state.lang === 'ar' ? 
                `Ù†ØªÙŠØ¬Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨: ${state.student}%0AØ§Ù„Ø¯Ø±Ø¬Ø©: ${final}/${state.maxScore}%0AØ§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø´Ø±Ù: ${state.teacher}%0AØ¨Ø§Ø±Ùƒ Ø§Ù„Ù„Ù‡ ÙÙŠÙ‡ ÙˆØ²Ø§Ø¯Ù‡ Ø­Ø±ØµØ§Ù‹.` :
                `Assessment result for: ${state.student}%0AScore: ${final}/${state.maxScore}%0ASupervising Teacher: ${state.teacher}%0AMay Allah bless them.`;
            window.open(`https://wa.me/?text=${text}`, '_blank');
        }

        function exportFullBackup() {
            const backup = { archive: state.archive, customBank: state.customBank, attendance: state.attendance, teacher: state.teacher, group: state.group };
            const blob = new Blob([JSON.stringify(backup)], {type: 'application/json'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `backup_${Date.now()}.json`;
            link.click();
        }

        function restoreData(e) {
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if(data.archive) localStorage.setItem('v25_archive', JSON.stringify(data.archive));
                    if(data.customBank) localStorage.setItem('custom_verses_v21', JSON.stringify(data.customBank));
                    if(data.attendance) localStorage.setItem('v27_attendance', JSON.stringify(data.attendance));
                    location.reload();
                } catch(e) { alert("Invalid file."); }
            };
            reader.readAsText(e.target.files[0]);
        }

        function closeProfile(e) { if(e.target.className === 'modal') e.target.style.display='none'; }
    </script>
</body>
</html>
