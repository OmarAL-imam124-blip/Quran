<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ Ø§Ù„Ø°ÙƒÙŠ - v8.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@300;500;700&display=swap');

        :root {
            --primary: #1a472a;
            --primary-light: #2d5a27;
            --secondary: #2c3e50;
            --accent: #c5a059;
            --bg: #f2f7f5;
            --card-bg: #ffffff;
            --text: #333;
            --border: #dee2e6;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Tajawal', sans-serif;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 2.5rem;
            text-align: center;
            border-bottom: 6px solid var(--accent);
            box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        }

        .app-header h1 {
            font-family: 'Amiri', serif;
            font-size: 2.8rem;
            margin-bottom: 0.2rem;
        }

        .container {
            max-width: 1300px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }

        .view {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .view.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 2.5rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0,0,0,0.03);
            margin-bottom: 2.5rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2.5rem;
        }

        h2 { color: var(--primary); margin-bottom: 1.8rem; font-size: 1.8rem; display: flex; align-items: center; gap: 12px; }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1.05rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-danger { background: var(--danger); color: white; }

        /* Mode Selector */
        .mode-selector {
            display: flex;
            background: #eee;
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 1.5rem;
        }
        .mode-option {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            font-weight: bold;
            transition: 0.3s;
        }
        .mode-option.active { background: var(--primary); color: white; }

        /* Charts SVG */
        .chart-container {
            width: 100%;
            height: 150px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 10px;
            margin-top: 1rem;
            display: flex;
            align-items: flex-end;
            gap: 5px;
        }
        .chart-bar {
            flex: 1;
            background: var(--accent);
            border-radius: 5px 5px 0 0;
            position: relative;
            transition: height 1s ease-in-out;
        }
        .chart-bar:hover::after {
            content: attr(data-val);
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            background: #333;
            color: #fff;
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* Verse Container */
        .verse-box {
            background: #fff;
            border: 3px solid var(--primary);
            border-radius: 30px;
            padding: 4rem 2rem;
            text-align: center;
            margin-bottom: 2.5rem;
            box-shadow: 0 10px 20px rgba(26,71,42,0.1);
        }
        .verse-text { font-family: 'Amiri', serif; font-size: 3.8rem; color: var(--primary); line-height: 1.5; margin-bottom: 1.5rem; }

        .tadabbur-box {
            background: #eefdf5;
            padding: 1.5rem;
            border-radius: 15px;
            color: #1a5d3b;
            display: none;
            margin-top: 20px;
            border-right: 6px solid var(--success);
            text-align: right;
            font-size: 1.2rem;
        }

        /* Tajweed Grid */
        .tajweed-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 2rem;
        }
        .taj-chip {
            background: #f8f9fa;
            border: 1.5px solid #dee2e6;
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
        }
        .taj-chip.selected { background: var(--danger); color: white; border-color: var(--danger); }

        /* Tables */
        .table-container { overflow-x: auto; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        table { width: 100%; border-collapse: collapse; background: #fff; }
        th, td { padding: 20px; text-align: right; border-bottom: 1px solid #f1f1f1; }
        th { background: #f9fbf9; color: var(--primary); font-weight: 700; font-size: 0.95rem; }
        tr:hover { background: #f8fcf9; }

        .student-link { color: var(--primary); font-weight: 700; cursor: pointer; text-decoration: none; border-bottom: 1.5px solid var(--accent); }

        .badge { padding: 6px 14px; border-radius: 25px; font-size: 0.85rem; font-weight: 800; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fffbeb; color: #92400e; }

        /* Badges/Medals */
        .medals-box { display: flex; gap: 5px; margin-top: 5px; }
        .medal-icon { font-size: 1.2rem; filter: grayscale(1); }
        .medal-icon.active { filter: grayscale(0); }

        /* Modal Overlay */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: none;
            justify-content: center; align-items: center; z-index: 1000;
            backdrop-filter: blur(6px);
        }
        .modal-body {
            background: white; border-radius: 30px; width: 95%; max-width: 800px;
            padding: 2.5rem; max-height: 90vh; overflow-y: auto; position: relative;
        }

        /* Certificate Styles */
        #printCertificate {
            width: 1000px; height: 700px; background: white; padding: 60px;
            border: 35px solid var(--primary); position: relative; display: none; margin: 0 auto;
        }
        #printCertificate::after {
            content: ""; position: absolute; top: 15px; left: 15px; right: 15px; bottom: 15px;
            border: 5px solid var(--accent); pointer-events: none;
        }

        @media print {
            body * { visibility: hidden; }
            #printCertificate, #printCertificate * { visibility: visible; }
            #printCertificate { position: absolute; left: 0; top: 0; display: block !important; }
        }

        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <header class="app-header no-print">
        <h1>Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ Ø§Ù„Ø°ÙƒÙŠ <small style="font-size: 1rem; opacity: 0.8;">v8.0</small></h1>
        <p>Ø¨Ø¥Ø´Ø±Ø§Ù Ù…Ø¹Ù„Ù… Ø§Ù„Ø­Ù„Ù‚Ø© Ø¹Ù…Ø± Ø¨Ù† Ø¹Ø¨Ø¯Ø§Ù„Ø­Ù…ÙŠØ¯ Ø§Ù„Ø¥Ù…Ø§Ù…</p>
    </header>

    <div class="container no-print">
        
        <!-- View 1: Main Dashboard -->
        <div id="mainDashboard" class="view active">
            <div class="main-grid">
                <!-- Registration & Stats -->
                <div class="main-column">
                    <div class="card">
                        <h2>ğŸ‘¤ Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯</h2>
                        <div class="mode-selector">
                            <div class="mode-option active" id="modeNormal" onclick="setMode('normal')">ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©</div>
                            <div class="mode-option" id="modeChallenge" onclick="setMode('challenge')">ÙˆØ¶Ø¹ Ø§Ù„Ù…ØªØ´Ø§Ø¨Ù‡Ø§Øª (ØªØ­Ø¯ÙŠ)</div>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <input type="text" id="studentSearchInput" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ..." style="flex: 1; padding: 15px; border-radius: 12px; border: 2px solid #eee; font-size: 1.1rem; outline: none; transition: 0.3s;" onfocus="this.style.borderColor='var(--primary)'">
                            <button class="btn btn-primary" onclick="startAssessment()">Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
                        </div>
                    </div>

                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h2>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø¹Ø§Ù…</h2>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="filterTableInput" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„..." style="padding: 8px 15px; border-radius: 10px; border: 1px solid #ddd;" onkeyup="filterTable()">
                                <button class="btn btn-outline btn-sm" onclick="exportDataExcel()">ØªØµØ¯ÙŠØ± CSV</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table id="mainResultsTable">
                                <thead>
                                    <tr>
                                        <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                        <th>Ø£ÙØ¶Ù„ Ø¯Ø±Ø¬Ø©</th>
                                        <th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
                                        <th>Ø¢Ø®Ø± Ø§Ø®ØªØ¨Ø§Ø±</th>
                                        <th>Ø£ÙˆØ³Ù…Ø©</th>
                                        <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsGrid"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Sidebar Widgets -->
                <div class="side-column">
                    <div class="card">
                        <h2>ğŸ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h2>
                        <div id="topStudentsList"></div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“– Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©</h2>
                        <div id="quickStats" style="font-size: 0.95rem; color: #555;">
                            Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø®ØªØ¨Ø±ÙŠÙ†: <b id="statTotalStudents">0</b><br>
                            Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥ØªÙ‚Ø§Ù† Ø§Ù„Ø¹Ø§Ù…Ø©: <b id="statMasteryPct">0%</b>
                        </div>
                    </div>

                    <div class="card" style="background: #fffdf5; border: 1px solid #ffeeba;">
                        <h2 style="font-size: 1.3rem;">ğŸ’¡ ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø¹Ù„Ù…</h2>
                        <p id="dailyPedagogicalTip" style="font-style: italic; color: #744210;"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- View 2: Live Assessment -->
        <div id="assessmentView" class="view">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2 id="liveStudentName">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨: ...</h2>
                    <div id="progressCounter" style="font-weight: bold; color: var(--accent); font-size: 1.4rem;">Ø§Ù„Ø³Ø¤Ø§Ù„ 1 / 5</div>
                </div>

                <div class="verse-box">
                    <div id="verseDisplayArea" class="verse-text"></div>
                    <button class="btn btn-outline btn-sm" onclick="toggleTadabbur()"><i class="icon">ğŸ’¡</i> ØªØ¯Ø¨Ø± Ø§Ù„Ø¢ÙŠØ©</button>
                    <div id="tadabburTextContent" class="tadabbur-box"></div>
                </div>

                <!-- Audio Component -->
                <div style="background: #fdfdfd; padding: 20px; border-radius: 20px; margin-bottom: 2rem; border: 1px dashed #ccc; text-align: center;">
                    <div id="recordingLabel" style="display:none; color: var(--danger); font-weight: bold; margin-bottom: 10px;">ğŸ”´ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨...</div>
                    <button id="recordButton" class="btn btn-danger" onclick="captureAudio()">ğŸ™ï¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</button>
                    <button id="previewAudioButton" class="btn btn-secondary" style="display:none" onclick="playCurrentPreview()">â–¶ï¸ Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ³Ø¬ÙŠÙ„</button>
                </div>

                <div class="tajweed-box">
                    <label style="font-weight: bold; font-size: 1.1rem; color: var(--primary);">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ¬ÙˆÙŠØ¯ÙŠØ©:</label>
                    <div class="tajweed-grid">
                        <div class="taj-chip" onclick="this.classList.toggle('selected')">ØºÙ†Ø©</div>
                        <div class="taj-chip" onclick="this.classList.toggle('selected')">Ù…Ø¯ÙˆØ¯</div>
                        <div class="taj-chip" onclick="this.classList.toggle('selected')">Ù…Ø®Ø§Ø±Ø¬</div>
                        <div class="taj-chip" onclick="this.classList.toggle('selected')">ÙˆÙ‚Ù</div>
                        <div class="taj-chip" onclick="this.classList.toggle('selected')">Ù‚Ù„Ù‚Ù„Ø©</div>
                        <div class="taj-chip" onclick="this.classList.toggle('selected')">Ø¥Ø®ÙØ§Ø¡</div>
                        <div class="taj-chip" onclick="this.classList.toggle('selected')">ØªÙØ®ÙŠÙ…</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
                    <button class="btn" style="background: var(--success); color: white; height: 70px; font-size: 1.5rem;" onclick="gradeStep(2)">ØµØ­ÙŠØ­ (2)</button>
                    <button class="btn" style="background: var(--warning); color: white; height: 70px; font-size: 1.5rem;" onclick="gradeStep(1)">ØªØ±Ø¯Ø¯ (1)</button>
                    <button class="btn" style="background: var(--danger); color: white; height: 70px; font-size: 1.5rem;" onclick="gradeStep(0)">Ø®Ø·Ø£ (0)</button>
                </div>
            </div>
        </div>

        <!-- View 3: Performance Summary -->
        <div id="performanceSummaryView" class="view">
            <div class="card" style="text-align: center; padding: 5rem 3rem;">
                <h2 style="justify-content: center; font-size: 2.5rem;">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
                <div style="font-size: 7rem; font-weight: 900; color: var(--primary); margin: 1.5rem 0;" id="finalScoreBadge">0 / 10</div>
                <div id="finalLevelStatus" style="margin-bottom: 2.5rem;"></div>
                
                <div id="awardNotice" style="display: none; padding: 2rem; background: #fdf6e3; border: 2px solid var(--accent); border-radius: 20px; margin-bottom: 2.5rem;">
                    âœ¨ Ù…Ù…ØªØ§Ø² Ø¬Ø¯Ø§Ù‹! Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ø³ØªØ­Ù‚ "ÙˆØ³Ø§Ù… Ø§Ù„Ø¶Ø§Ø¨Ø·" Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….
                </div>

                <div style="display: flex; gap: 20px; justify-content: center;">
                    <button id="btnCertificate" class="btn btn-accent" style="display:none" onclick="triggerCertificatePrint()">ğŸ“„ Ø´Ù‡Ø§Ø¯Ø© ØªÙ‚Ø¯ÙŠØ±</button>
                    <button class="btn btn-primary" onclick="saveRecordAndClose()">Ø­ÙØ¸ ÙˆØ¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Deep Dive Modal -->
    <div id="studentProfileModal" class="modal" onclick="closeProfile(event)">
        <div class="modal-body" onclick="event.stopPropagation()">
            <button style="position: absolute; top: 20px; left: 20px; border: none; background: #eee; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; cursor: pointer;" onclick="document.getElementById('studentProfileModal').style.display='none'">âœ•</button>
            <h2 id="profStudentName">Ù…Ù„Ù Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 2rem;">
                <div style="background: #f1f5f9; padding: 20px; border-radius: 20px;">
                    <b>ØªØ­Ù„ÙŠÙ„ Ù…Ø³Ø§Ø± Ø§Ù„ØªÙ‚Ø¯Ù…:</b>
                    <div class="chart-container" id="studentProgressChart"></div>
                </div>
                <div style="background: #f1f5f9; padding: 20px; border-radius: 20px;">
                    <b>Ø§Ù„Ø£ÙˆØ³Ù…Ø© Ø§Ù„Ù…Ø­Ù‚Ù‚Ø©:</b>
                    <div id="studentAwardsList" style="font-size: 2.5rem; margin-top: 10px;"></div>
                </div>
            </div>

            <div id="studentHistoryTable"></div>
        </div>
    </div>

    <!-- Certificate Template -->
    <div id="printCertificate">
        <div style="text-align: center; height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
            <p style="font-size: 1.4rem;">Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…</p>
            <h1 style="font-size: 4rem; color: var(--primary); font-family: 'Amiri';">Ø´Ù‡Ø§Ø¯Ø© Ø¥ØªÙ‚Ø§Ù† ÙˆØªÙÙˆÙ‚</h1>
            <p style="font-size: 1.8rem;">ÙŠØ´Ù‡Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù… Ø¹Ù…Ø± Ø¨Ù† Ø¹Ø¨Ø¯Ø§Ù„Ø­Ù…ÙŠØ¯ Ø§Ù„Ø¥Ù…Ø§Ù… Ø£Ù† Ø§Ù„Ø·Ø§Ù„Ø¨:</p>
            <div id="certNameSlot" style="font-size: 3.5rem; color: var(--accent); font-family: 'Amiri'; border-bottom: 3px dashed var(--primary); width: 85%; margin: 15px auto;">...</div>
            <p style="font-size: 1.8rem;">Ù‚Ø¯ Ø£ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¬Ø²Ø¡ ØªØ¨Ø§Ø±Ùƒ Ø¨Ø§Ù…ØªÙŠØ§Ø² ÙˆØ¨Ø¯Ø±Ø¬Ø©:</p>
            <div id="certScoreSlot" style="font-size: 3rem; font-weight: bold; color: var(--primary);">10 / 10</div>
            <p style="font-size: 1.5rem; color: #555;">Ø²Ø§Ø¯Ùƒ Ø§Ù„Ù„Ù‡ Ø­Ø¨Ø§Ù‹ Ù„Ù„Ù‚Ø±Ø¢Ù† ÙˆØ£Ù‡Ù„Ù‡</p>
            <div style="display: flex; justify-content: space-around; margin-top: 40px;">
                <p>ØªØ§Ø±ÙŠØ®: <span id="certDateSlot"></span></p>
                <p>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…</p>
            </div>
        </div>
    </div>

    <script>
        // --- Database & Storage ---
        let storageDB;
        const req = indexedDB.open("QuranMasterV8", 1);
        req.onupgradeneeded = (e) => {
            storageDB = e.target.result;
            if (!storageDB.objectStoreNames.contains("voiceLogs")) {
                storageDB.createObjectStore("voiceLogs", { keyPath: "id" });
            }
        };
        req.onsuccess = (e) => { storageDB = e.target.result; syncDashboard(); };

        // --- Question Content (Enhanced v8) ---
        const verseBank = [
            { t: "ï´¿ÙˆÙØ§Ù„Ù’Ù…ÙØ±Ù’Ø³ÙÙ„ÙØ§ØªÙ Ø¹ÙØ±Ù’ÙÙ‹Ø§ï´¾", s: "Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª", m: "Ø£Ù‚Ø³Ù… Ø§Ù„Ù„Ù‡ Ø¨Ø§Ù„Ø±ÙŠØ§Ø­ Ø§Ù„Ù…ØªØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙŠ ØªØ£ØªÙŠ Ø¨Ø§Ù„Ø®ÙŠØ±.", c: false },
            { t: "ï´¿ÙÙØ§Ù„Ù’Ù…ÙÙ„Ù’Ù‚ÙÙŠÙØ§ØªÙ Ø°ÙÙƒÙ’Ø±Ù‹Ø§ï´¾", s: "Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª", m: "Ø§Ù„Ù…Ù„Ø§Ø¦ÙƒØ© Ø§Ù„ØªÙŠ ØªØªÙ†Ø²Ù„ Ø¨Ø§Ù„ÙˆØ­ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ù„.", c: true },
            { t: "ï´¿Ù‡ÙÙ„Ù’ Ø£ÙØªÙÙ‰Ù° Ø¹ÙÙ„ÙÙ‰ Ø§Ù„Ù’Ø¥ÙÙ†Ø³ÙØ§Ù†Ù Ø­ÙÙŠÙ†ÙŒ Ù…Ù‘ÙÙ†Ù Ø§Ù„Ø¯Ù‘ÙÙ‡Ù’Ø±Ùï´¾", s: "Ø§Ù„Ø¥Ù†Ø³Ø§Ù†", m: "ØªØ°ÙƒÙŠØ± Ø§Ù„Ø¥Ù†Ø³Ø§Ù† Ø¨Ø£ØµÙ„Ù‡ ÙˆÙƒÙŠÙ ÙƒØ§Ù† Ù„Ø§ Ø´ÙŠØ¡ Ù‚Ø¨Ù„ Ø®Ù„Ù‚Ù‡.", c: false },
            { t: "ï´¿Ø¥ÙÙ†Ù‘ÙØ§ Ù‡ÙØ¯ÙÙŠÙ’Ù†ÙØ§Ù‡Ù Ø§Ù„Ø³Ù‘ÙØ¨ÙÙŠÙ„Ùï´¾", s: "Ø§Ù„Ø¥Ù†Ø³Ø§Ù†", m: "Ø¨ÙŠÙ† Ø§Ù„Ù„Ù‡ Ù„Ù„Ø¥Ù†Ø³Ø§Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„Ù‡Ø¯Ù‰ ÙˆØ§Ù„Ø¶Ù„Ø§Ù„ Ù„ÙŠØ®ØªØ§Ø±.", c: false },
            { t: "ï´¿Ù„ÙØ§ Ø£ÙÙ‚Ù’Ø³ÙÙ…Ù Ø¨ÙÙŠÙÙˆÙ’Ù…Ù Ø§Ù„Ù’Ù‚ÙÙŠÙØ§Ù…ÙØ©Ùï´¾", s: "Ø§Ù„Ù‚ÙŠØ§Ù…Ø©", m: "Ù‚Ø³Ù… Ø¹Ø¸ÙŠÙ… Ø¨ÙŠÙˆÙ… Ø§Ù„Ø¨Ø¹Ø« ÙˆØ§Ù„Ø­Ø³Ø§Ø¨.", c: false },
            { t: "ï´¿ÙŠÙØ§ Ø£ÙÙŠÙ‘ÙÙ‡ÙØ§ Ø§Ù„Ù’Ù…ÙØ¯Ù‘ÙØ«Ù‘ÙØ±Ùï´¾", s: "Ø§Ù„Ù…Ø¯Ø«Ø±", m: "Ù†Ø¯Ø§Ø¡ Ù„Ù„Ù†Ø¨ÙŠ ï·º Ø¨Ø§Ù„Ù‚ÙŠØ§Ù… ÙˆØ§Ù„ØªØ¨Ù„ÙŠØº ÙˆØ§Ù„Ø¥Ù†Ø°Ø§Ø±.", c: false },
            { t: "ï´¿ÙŠÙØ§ Ø£ÙÙŠÙ‘ÙÙ‡ÙØ§ Ø§Ù„Ù’Ù…ÙØ²Ù‘ÙÙ…Ù‘ÙÙ„Ùï´¾", s: "Ø§Ù„Ù…Ø²Ù…Ù„", m: "Ø¯Ø¹ÙˆØ© Ù„Ù‚ÙŠØ§Ù… Ø§Ù„Ù„ÙŠÙ„ ÙˆØ§Ù„ØªÙ‚Ø±Ø¨ Ù„Ù„Ù‡ Ø¨Ø§Ù„Ø¹Ø¨Ø§Ø¯Ø©.", c: true },
            { t: "ï´¿ÙˆÙØ±ÙØªÙ‘ÙÙ„Ù Ø§Ù„Ù’Ù‚ÙØ±Ù’Ø¢Ù†Ù ØªÙØ±Ù’ØªÙÙŠÙ„Ù‹Ø§ï´¾", s: "Ø§Ù„Ù…Ø²Ù…Ù„", m: "Ø§Ù„Ø£Ù…Ø± Ø¨Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚Ø±Ø¢Ù† Ø¨ØªØ¤Ø¯Ø© ÙˆØ·Ù…Ø£Ù†ÙŠÙ†Ø© ÙˆØªØ¯Ø¨Ø±.", c: false },
            { t: "ï´¿Ø¥ÙÙ†Ù‘ÙØ§ Ø³ÙÙ†ÙÙ„Ù’Ù‚ÙÙŠ Ø¹ÙÙ„ÙÙŠÙ’ÙƒÙ Ù‚ÙÙˆÙ’Ù„Ù‹Ø§ Ø«ÙÙ‚ÙÙŠÙ„Ù‹Ø§ï´¾", s: "Ø§Ù„Ù…Ø²Ù…Ù„", m: "Ø§Ù„Ù‚Ø±Ø¢Ù† Ø¹Ø¸ÙŠÙ… Ø§Ù„Ù‚Ø¯Ø± ÙˆÙ…Ø³Ø¤ÙˆÙ„ÙŠØ© ØªØ¨Ù„ÙŠØºÙ‡ Ø«Ù‚ÙŠÙ„Ø©.", c: false },
            { t: "ï´¿ÙƒÙÙ„Ù‘ÙØ§ Ø¥ÙØ°ÙØ§ Ø¨ÙÙ„ÙØºÙØªÙ Ø§Ù„ØªÙ‘ÙØ±ÙØ§Ù‚ÙÙŠÙï´¾", s: "Ø§Ù„Ù‚ÙŠØ§Ù…Ø©", m: "ÙˆØµÙ Ù„Ù„Ø­Ø¸Ø© Ù…ÙØ§Ø±Ù‚Ø© Ø§Ù„Ø±ÙˆØ­ Ù„Ù„Ø¬Ø³Ø¯ ÙˆÙ…ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø­Ù‚.", c: true },
            { t: "ï´¿Ø¨ÙÙ„Ù Ø§Ù„Ù’Ø¥ÙÙ†Ø³ÙØ§Ù†Ù Ø¹ÙÙ„ÙÙ‰Ù° Ù†ÙÙÙ’Ø³ÙÙ‡Ù Ø¨ÙØµÙÙŠØ±ÙØ©ÙŒï´¾", s: "Ø§Ù„Ù‚ÙŠØ§Ù…Ø©", m: "ÙƒÙ„ Ø¥Ù†Ø³Ø§Ù† Ø´Ø§Ù‡Ø¯ Ø¹Ù„Ù‰ Ø¬ÙˆØ§Ø±Ø­Ù‡ ÙˆØ£Ø¹Ù…Ø§Ù„Ù‡ ÙŠÙˆÙ… Ø§Ù„Ø­Ø³Ø§Ø¨.", c: false },
            { t: "ï´¿ÙˆÙÙŠÙØ·Ù’Ø¹ÙÙ…ÙÙˆÙ†Ù Ø§Ù„Ø·Ù‘ÙØ¹ÙØ§Ù…Ù Ø¹ÙÙ„ÙÙ‰ Ø­ÙØ¨Ù‘ÙÙ‡Ùï´¾", s: "Ø§Ù„Ø¥Ù†Ø³Ø§Ù†", m: "ÙØ¶Ù„ Ø§Ù„Ø¥ÙŠØ«Ø§Ø± ÙˆØ§Ù„ØµØ¯Ù‚Ø© ÙˆØ¥Ø·Ø¹Ø§Ù… Ø§Ù„Ù…Ø³Ø§ÙƒÙŠÙ† Ù„ÙˆØ¬Ù‡ Ø§Ù„Ù„Ù‡.", c: false },
            { t: "ï´¿Ø£ÙÙ„ÙÙ…Ù’ Ù†ÙØ®Ù’Ù„ÙÙ‚ÙƒÙ‘ÙÙ… Ù…Ù‘ÙÙ† Ù…Ù‘ÙØ§Ø¡Ù Ù…Ù‘ÙÙ‡ÙÙŠÙ†Ùï´¾", s: "Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª", m: "Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù‚Ø¯Ø±Ø© Ø§Ù„Ø¥Ù„Ù‡ÙŠØ© ÙÙŠ Ø®Ù„Ù‚ Ø§Ù„Ø¥Ù†Ø³Ø§Ù† Ù…Ù† Ø¶Ø¹Ù.", c: true },
            { t: "ï´¿Ø¹ÙÙ„ÙÙŠÙ’Ù‡ÙØ§ ØªÙØ³Ù’Ø¹ÙØ©Ù Ø¹ÙØ´ÙØ±Ùï´¾", s: "Ø§Ù„Ù…Ø¯Ø«Ø±", m: "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„Ø§Ø¦ÙƒØ© Ø§Ù„Ø°ÙŠÙ† ÙŠØ­Ø±Ø³ÙˆÙ† Ø¬Ù‡Ù†Ù… ÙˆØ­ÙƒÙ…Ø© Ø§Ù„Ù„Ù‡ ÙÙŠÙ‡Ù….", c: false },
            { t: "ï´¿Ø£ÙÙŠÙØ­Ù’Ø³ÙØ¨Ù Ø§Ù„Ù’Ø¥ÙÙ†Ø³ÙØ§Ù†Ù Ø£ÙÙ„Ù‘ÙÙ† Ù†Ù‘ÙØ¬Ù’Ù…ÙØ¹Ù Ø¹ÙØ¸ÙØ§Ù…ÙÙ‡Ùï´¾", s: "Ø§Ù„Ù‚ÙŠØ§Ù…Ø©", m: "Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ù…Ù† Ø£Ù†ÙƒØ± Ù‚Ø¯Ø±Ø© Ø§Ù„Ù„Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø¹Ø«.", c: true },
            { t: "ï´¿ÙˆÙØ§ØµÙ’Ø¨ÙØ±Ù’ Ø¹ÙÙ„ÙÙ‰ Ù…ÙØ§ ÙŠÙÙ‚ÙÙˆÙ„ÙÙˆÙ†Ùï´¾", s: "Ø§Ù„Ù…Ø²Ù…Ù„", m: "Ø£Ù…Ø± Ù„Ù„Ù†Ø¨ÙŠ ï·º Ø¨Ø§Ù„ØµØ¨Ø± Ø§Ù„Ø¬Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø£Ø°Ù‰ Ø§Ù„Ù…ÙƒØ°Ø¨ÙŠÙ†.", c: false }
        ];

        const pedagogicTips = [
            "Ø§Ù„ØµØ¨Ø± Ø¹Ù„Ù‰ ØªØ¹Ø«Ø± Ø§Ù„Ø·Ø§Ù„Ø¨ Ù‡Ùˆ Ø£ÙˆÙ„ Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø¥ØªÙ‚Ø§Ù†.",
            "Ø§Ø±Ø¨Ø· Ø§Ù„Ø¢ÙŠØ© Ø¨Ù…Ø¹Ù†Ø§Ù‡Ø§ Ø­ØªÙ‰ ÙŠÙ‚Ø±Ø£Ù‡Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù‚Ù„Ø¨Ù‡ Ù„Ø§ Ø¨Ù„Ø³Ø§Ù†Ù‡ ÙÙ‚Ø·.",
            "Ø§Ù„Ø«Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø£Ù…Ø§Ù… Ø£Ù‚Ø±Ø§Ù†Ù‡ ÙŠØµÙ†Ø¹ Ù…Ù†Ù‡ Ø­Ø§ÙØ¸Ø§Ù‹ Ù…ØªÙ…ÙŠØ²Ø§Ù‹.",
            "Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù†Ø§Ø¬Ø­ Ù‡Ùˆ Ù…Ù† ÙŠØ¨Ù†ÙŠ Ø¹Ù„Ø§Ù‚Ø© Ù…Ø­Ø¨Ø© Ø¨ÙŠÙ† Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ§Ù„Ù…ØµØ­Ù.",
            "Ø§Ù„Ø¬ÙˆØ¯Ø© ÙÙŠ Ù…Ø®Ø§Ø±Ø¬ Ø§Ù„Ø­Ø±ÙˆÙ Ù…Ù‚Ø¯Ù…Ø© Ø¹Ù„Ù‰ Ø³Ø±Ø¹Ø© Ø§Ù„Ø®ØªÙ…."
        ];

        // --- App State ---
        let appState = {
            mode: 'normal',
            student: "",
            scores: [],
            mistakes: [],
            step: 0,
            activeVerses: [],
            voiceBlobs: [],
            archive: JSON.parse(localStorage.getItem('v8_master_archive') || '[]')
        };

        let activeRecorder, audioChunks = [];

        // --- UI Logic ---
        function switchView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0,0);
        }

        function setMode(m) {
            appState.mode = m;
            document.getElementById('modeNormal').classList.toggle('active', m === 'normal');
            document.getElementById('modeChallenge').classList.toggle('active', m === 'challenge');
        }

        function startAssessment() {
            const name = document.getElementById('studentSearchInput').value.trim();
            if (!name) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨");

            appState.student = name;
            appState.scores = [];
            appState.mistakes = [];
            appState.step = 0;
            appState.voiceBlobs = [];
            
            // Selection logic
            let pool = appState.mode === 'challenge' ? verseBank.filter(v => v.c) : verseBank;
            appState.activeVerses = [...pool].sort(() => 0.5 - Math.random()).slice(0, 5);

            document.getElementById('liveStudentName').innerText = `Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨: ${name}`;
            updateStep();
            switchView('assessmentView');
        }

        function updateStep() {
            const v = appState.activeVerses[appState.step];
            document.getElementById('progressCounter').innerText = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${appState.step + 1} / 5`;
            document.getElementById('verseDisplayArea').innerText = v.t;
            document.getElementById('tadabburTextContent').innerText = v.m;
            document.getElementById('tadabburTextContent').style.display = "none";
            document.querySelectorAll('.taj-chip').forEach(c => c.classList.remove('selected'));
            document.getElementById('previewAudioButton').style.display = "none";
        }

        function toggleTadabbur() {
            const box = document.getElementById('tadabburTextContent');
            box.style.display = box.style.display === "none" ? "block" : "none";
        }

        function gradeStep(pts) {
            appState.scores.push(pts);
            document.querySelectorAll('.taj-chip.selected').forEach(c => appState.mistakes.push(c.innerText));
            
            appState.step++;
            if (appState.step < 5) {
                updateStep();
            } else {
                renderSummary();
            }
        }

        function renderSummary() {
            const total = appState.scores.reduce((a,b) => a+b, 0);
            const level = total >= 9 ? "Ù…Ù…ØªØ§Ø²" : total >= 7 ? "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹" : "ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©";
            
            document.getElementById('finalScoreBadge').innerText = `${total} / 10`;
            document.getElementById('finalLevelStatus').innerHTML = `<span class="badge ${total >= 9 ? 'badge-success' : 'badge-warning'}">${level}</span>`;
            
            if (total >= 9) {
                document.getElementById('btnCertificate').style.display = "inline-flex";
                document.getElementById('awardNotice').style.display = "block";
            } else {
                document.getElementById('btnCertificate').style.display = "none";
                document.getElementById('awardNotice').style.display = "none";
            }
            switchView('performanceSummaryView');
        }

        function saveRecordAndClose() {
            const total = appState.scores.reduce((a,b) => a+b, 0);
            const rid = Date.now();
            const record = {
                id: rid,
                name: appState.student,
                score: total,
                level: (total >= 9 ? "Ù…Ù…ØªØ§Ø²" : total >= 7 ? "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹" : "ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©"),
                mistakes: [...new Set(appState.mistakes)].join('ØŒ '),
                date: new Date().toLocaleDateString('ar-SA'),
                timestamp: rid,
                hasAudio: appState.voiceBlobs.length > 0
            };

            appState.archive.unshift(record);
            localStorage.setItem('v8_master_archive', JSON.stringify(appState.archive));

            // Store Audio in IndexedDB
            if (appState.voiceBlobs.length > 0) {
                const blob = new Blob(appState.voiceBlobs, { type: 'audio/webm' });
                const tx = storageDB.transaction(["voiceLogs"], "readwrite");
                tx.objectStore("voiceLogs").add({ id: rid, blob: blob });
            }

            syncDashboard();
            document.getElementById('studentSearchInput').value = "";
            switchView('mainDashboard');
        }

        // --- Dashboard Sync ---
        function syncDashboard() {
            const list = document.getElementById('resultsGrid');
            list.innerHTML = '';
            
            // Unique student aggregation for Best Score & Medals
            const students = {};
            appState.archive.forEach(r => {
                if (!students[r.name] || students[r.name].score < r.score) {
                    students[r.name] = r;
                }
            });

            Object.values(students).slice(0, 20).forEach(res => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="student-link" onclick="openProfileDetail('${res.name}')">${res.name}</span></td>
                    <td><b>${res.score}/10</b></td>
                    <td><span class="badge ${res.score >= 9 ? 'badge-success' : 'badge-warning'}">${res.level}</span></td>
                    <td style="font-size:0.8rem;">${res.date}</td>
                    <td>
                        <div class="medals-box">
                            <span class="medal-icon ${res.score >= 7 ? 'active' : ''}">â­</span>
                            <span class="medal-icon ${res.score >= 9 ? 'active' : ''}">ğŸ†</span>
                            <span class="medal-icon ${res.score === 10 ? 'active' : ''}">ğŸ‘‘</span>
                        </div>
                    </td>
                    <td><button onclick="deleteRecord(${res.id})" style="border:none; background:none; cursor:pointer;">âŒ</button></td>
                `;
                list.appendChild(tr);
            });

            // Stats
            const uniqueCount = Object.keys(students).length;
            document.getElementById('statTotalStudents').innerText = uniqueCount;
            const avgMastery = uniqueCount > 0 ? (appState.archive.filter(r => r.score >= 9).length / appState.archive.length * 100).toFixed(1) : 0;
            document.getElementById('statMasteryPct').innerText = `${avgMastery}%`;

            updateLeaders(students);
            document.getElementById('dailyPedagogicalTip').innerText = pedagogicTips[Math.floor(Math.random() * pedagogicTips.length)];
        }

        function updateLeaders(studentMap) {
            const container = document.getElementById('topStudentsList');
            const sorted = Object.values(studentMap).sort((a,b) => b.score - a.score).slice(0, 5);
            container.innerHTML = sorted.length ? '' : '<p style="font-size:0.9rem; color:#888;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª.</p>';
            sorted.forEach((s, i) => {
                container.innerHTML += `
                    <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;">
                        <span>${i+1}. ${s.name}</span>
                        <b style="color:var(--primary)">${s.score}/10</b>
                    </div>
                `;
            });
        }

        function openProfileDetail(name) {
            const history = appState.archive.filter(r => r.name === name).sort((a,b) => a.timestamp - b.timestamp);
            document.getElementById('profStudentName').innerText = `Ù…Ù„Ù Ø§Ù„Ø·Ø§Ù„Ø¨: ${name}`;
            
            // Build Chart (Simple SVG Implementation)
            const chart = document.getElementById('studentProgressChart');
            chart.innerHTML = '';
            history.slice(-15).forEach(h => {
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = (h.score * 10) + '%';
                bar.setAttribute('data-val', h.score);
                chart.appendChild(bar);
            });

            // Awards
            const max = Math.max(...history.map(h => h.score));
            const awards = document.getElementById('studentAwardsList');
            awards.innerHTML = max >= 7 ? 'â­' : '';
            awards.innerHTML += max >= 9 ? 'ğŸ†' : '';
            awards.innerHTML += max === 10 ? 'ğŸ‘‘' : '';

            // Table
            const container = document.getElementById('studentHistoryTable');
            container.innerHTML = '<h4>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª:</h4>';
            history.reverse().forEach(h => {
                container.innerHTML += `
                    <div style="padding:12px; border:1px solid #eee; border-radius:15px; margin-bottom:10px; background:#fff;">
                        <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                            <span>Ø¯Ø±Ø¬Ø©: <b>${h.score}/10</b></span>
                            <span>${h.date}</span>
                        </div>
                        <div style="font-size:0.8rem; color:#777;">Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: ${h.mistakes || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div>
                        ${h.hasAudio ? `<button class="btn btn-sm btn-outline" style="margin-top:5px;" onclick="playSavedAudio(${h.id})">â–¶ï¸ Ø§Ø³ØªÙ…Ø§Ø¹</button>` : ''}
                    </div>
                `;
            });

            document.getElementById('studentProfileModal').style.display = "flex";
        }

        // --- Audio Logic ---
        async function captureAudio() {
            const btn = document.getElementById('recordButton');
            const label = document.getElementById('recordingLabel');
            if (activeRecorder && activeRecorder.state === "recording") {
                activeRecorder.stop();
                btn.innerText = "ğŸ™ï¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©";
                btn.classList.replace('btn-secondary', 'btn-danger');
                label.style.display = "none";
            } else {
                try {
                    const str = await navigator.mediaDevices.getUserMedia({ audio: true });
                    activeRecorder = new MediaRecorder(str);
                    audioChunks = [];
                    activeRecorder.ondataavailable = e => audioChunks.push(e.data);
                    activeRecorder.onstop = () => {
                        const blob = new Blob(audioChunks, { type: 'audio/webm' });
                        appState.voiceBlobs.push(blob);
                        window.currentPreviewUrl = URL.createObjectURL(blob);
                        document.getElementById('previewAudioButton').style.display = "inline-flex";
                    };
                    activeRecorder.start();
                    btn.innerText = "ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„";
                    btn.classList.replace('btn-danger', 'btn-secondary');
                    label.style.display = "block";
                } catch (err) { alert("ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†."); }
            }
        }

        function playCurrentPreview() { if(window.currentPreviewUrl) new Audio(window.currentPreviewUrl).play(); }

        function playSavedAudio(id) {
            const tx = storageDB.transaction(["voiceLogs"], "readonly");
            const req = tx.objectStore("voiceLogs").get(id);
            req.onsuccess = () => { if(req.result) new Audio(URL.createObjectURL(req.result.blob)).play(); };
        }

        // --- Utils ---
        function triggerCertificatePrint() {
            document.getElementById('certNameSlot').innerText = appState.student;
            document.getElementById('certScoreSlot').innerText = `${appState.scores.reduce((a,b)=>a+b,0)} / 10`;
            document.getElementById('certDateSlot').innerText = new Date().toLocaleDateString('ar-SA');
            window.print();
        }

        function filterTable() {
            const input = document.getElementById('filterTableInput').value.toUpperCase();
            const table = document.getElementById('mainResultsTable');
            const tr = table.getElementsByTagName('tr');
            for (let i = 1; i < tr.length; i++) {
                let td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    let txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(input) > -1 ? "" : "none";
                }
            }
        }

        function exportDataExcel() {
            let csv = "Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨,Ø§Ù„Ø¯Ø±Ø¬Ø©,Ø§Ù„ØªÙ‚Ø¯ÙŠØ±,Ø§Ù„Ø£Ø®Ø·Ø§Ø¡,Ø§Ù„ØªØ§Ø±ÙŠØ®\n";
            appState.archive.forEach(r => csv += `${r.name},${r.score},${r.level},${r.mistakes},${r.date}\n`);
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Ø³Ø¬Ù„_Ø§Ù„Ø­Ù„Ù‚Ø©_${Date.now()}.csv`;
            link.click();
        }

        function deleteRecord(id) {
            if(confirm("Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù†ØªÙŠØ¬Ø©ØŸ")) {
                appState.archive = appState.archive.filter(r => r.id !== id);
                localStorage.setItem('v8_master_archive', JSON.stringify(appState.archive));
                const tx = storageDB.transaction(["voiceLogs"], "readwrite");
                tx.objectStore("voiceLogs").delete(id);
                syncDashboard();
            }
        }

        function closeProfile(e) { if(e.target.className === 'modal') e.target.style.display = 'none'; }
    </script>
</body>
</html>
